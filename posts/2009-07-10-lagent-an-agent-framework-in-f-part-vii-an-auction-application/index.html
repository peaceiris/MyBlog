<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff"/>


<meta name="description" content="Download framework here.
All posts are here:
 Part I - Workers and ParallelWorkers Part II - Agents and control messages Part III - Default error management Part IV - Custom error management Part V - Timeout management Part VI - Hot swapping of code Part VII - An auction framework Part VIII – Implementing MapReduce (user model) Part IX – Counting words …  Here is an application that uses the framework we have been creating.">





<link rel="preload" href="../../fonts/SourceSerifVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../fonts/SourceSansVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<link rel="stylesheet" href="../../css/base.css"> 
<link rel="stylesheet" href="../../css/fonts.css">


  <link rel="preload" href="../../fonts/SourceCodeVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceCodeVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceSerifVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">



  <title>LAgent: an agent framework in F# – part VII – An auction application | Lucabol blog</title>


<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../site.webmanifest">
    </head>
<body>
    <header>
        <div id="topnav">
            <a id="logo" href="../../">❧</a>
            
                <time id="blog_date" > 2009/07/07</time>
            
            <span class="offline">~~ Offline ~~</span>
            <span class="rightnav">
                <a id="theme">theme</a><div class="dropdown-content">
          <a class="font-name" data-classname="OpenDyslexic" >0. OpenDyslexic</a>
          <a class="font-name" data-classname="Cardo" >1. Se Old Style: Cardo (Minion, Gallard, Centaur)</a>
          <a class="font-name" data-classname="CrimsonPro" >1. Se Old Style: Crimson Pro (Century, Palatino, Plantin, Sabon)</a>
          <a class="font-name" data-classname="EBGaramond" >1. Se Old Style: Garamond</a>
          <a class="font-name" data-classname="Gentium" >1. Se Old Style: Gentium</a>
          <a class="font-name" data-classname="GoudyStM" >1. Se Old Style: Sorts Mill Goudy</a>
          <a class="font-name" data-classname="LibreBaskerville" >4. Se Transitional: Libre Bask. (Mrs Eaves)</a>
          <a class="font-name" data-classname="LibreCaslon" >4. Se Transitional: Libre Caslon</a>
          <a class="font-name" data-classname="PT" >4. Se Transitional: PT fonts (Le Monde)</a>
          <a class="font-name" data-classname="SourcePro" >4. Se Transitional: Source Pro (Skolar, Fournier)</a>
          <a class="font-name" data-classname="TimesNewRoman" >4. Se Transitional: Times New Roman</a>
          <a class="font-name" data-classname="CM" >5. Se Didone: Computer Modern</a>
          <a class="font-name" data-classname="OldStandardTT" >5. Se Didone: Old Standard TT (Filosofia, Scotch Modern)</a>
          <a class="font-name" data-classname="STIX2" >5. Se Didone: Stix2</a>
          <a class="font-name" data-classname="Charter" >6. Se Scotch: Charter</a>
          <a class="font-name" data-classname="Georgia" >6. Se Scotch: Georgia</a>
          <a class="font-name" data-classname="WorkSans" >8. Sa Grotesque: Work Sans (All Grotesque, FF Bau, Venus)</a>
          <a class="font-name" data-classname="AntiqueOlive" >9. Sa Geometric: Antique Oliv</a>
          <a class="font-name" data-classname="bahnschrift" >9. Sa Geometric: Bahnschrift</a>
          <a class="font-name" data-classname="CooperHewitt" >9. Sa Geometric: Cooper Hewitt (Calibre)</a>
          <a class="font-name" data-classname="SourceSans" >9. Sa Humanist: Source Sans (Balto, Adelle Sans)</a>
          <a class="font-name" data-classname="URWClassico" >9. Sa Humanist: URW Classico (Optima)</a>
          <a class="font-name" data-classname="FiraSans" >a. Sa Humanist: Fira Sans (FF Meta)</a>
          <a class="font-name" data-classname="Nimbus" >a. Sa Humanist: Nimbus (Helvetica)</a>
          <a class="font-name" data-classname="Roboto" >a. Sa Humanist: Roboto (DIN</a>
          <a class="font-name" data-classname="Munson" >b. Sl Grotesque: Munson (Clarendon)</a>
          <a class="font-name" data-classname="Sanchez" >c. Sl Geometric: Sanchez (Rockwell)</a>
          <a class="font-name" data-classname="Enriqueta" >d. Sl Humanist: Enriqueta (PMN Caecilia)</a>
          <a class="font-name" data-classname="Merriweather" >d. Sl Humanist: Merriweather (Chapparal)</a>
          <a class="font-name" data-classname="profont" >Z. Sa Monospace: Profont</a>
</div>
                <a id="to_nav">Menu</a>
                <nav id="primary_nav">
                    

  <a href="../../MyBlog/">home</a>
  <a href="../../MyBlog/tags/">tags</a>
  <a href="https://www.github.com/lucabol">github</a>
  <a href="https://www.linkedin.com/in/lucabolognese/">linkdin</a>
  <a href="../../MyBlog/search">search</a>
  <a href="../../MyBlog/index.xml">rss</a>
                </nav>
            </span>
        </div>
    <h1 id="title">
    
        LAgent: an agent framework in F# – part VII – An auction application
    
    </h1>

    </header>

    <main>
        

<p>Download framework <a href="http://code.msdn.microsoft.com/LAgent">here</a>.</p>
<p>All posts are here:</p>
<ul>
<li><a href="http://blogs.msdn.com/lucabol/archive/2009/05/29/lagent-an-agent-framework-in-f-part-i-workers-and-parallelworkers.aspx">Part I  - Workers and ParallelWorkers</a></li>
<li><a href="http://blogs.msdn.com/lucabol/archive/2009/06/05/lagent-an-agent-framework-in-f-part-ii-agents-and-control-messages.aspx">Part II  - Agents and control messages</a></li>
<li><a href="http://blogs.msdn.com/lucabol/archive/2009/06/12/lagent-an-agent-framework-in-f-part-iii-default-error-management.aspx">Part III  - Default error management</a></li>
<li><a href="http://blogs.msdn.com/lucabol/archive/2009/06/19/lagent-an-agent-framework-in-f-part-iv-custom-error-management.aspx">Part IV  - Custom error management</a></li>
<li><a href="http://blogs.msdn.com/lucabol/archive/2009/06/26/lagent-an-agent-framework-in-f-part-v-timeout-management.aspx">Part V  - Timeout management</a></li>
<li><a href="http://blogs.msdn.com/lucabol/archive/2009/07/03/lagent-an-agent-framework-in-f-part-vi-hot-swapping-of-code-and-something-silly.aspx">Part VI  - Hot swapping of code</a></li>
<li><a href="http://blogs.msdn.com/lucabol/archive/2009/07/10/lagent-an-agent-framework-in-f-part-vii-an-auction-application.aspx">Part VII  - An auction framework</a></li>
<li><a href="http://blogs.msdn.com/lucabol/archive/2009/09/04/lagent-an-agent-framework-in-f-part-viii-implementing-mapreduce-user-model.aspx">Part VIII – Implementing MapReduce (user model)</a></li>
<li><a href="http://blogs.msdn.com/lucabol/archive/2009/09/18/lagent-an-agent-framework-in-f-part-ix-counting-words.aspx">Part IX – Counting words …</a></li>
</ul>
<p>Here is an application that uses the framework we have been creating. It is an auction application and it is described in more detail <a href="http://codebetter.com/blogs/matthew.podwysocki/archive/2009/05/20/f-actors-revisited.aspx">here</a>.</p>
<p>Let’s go through it.</p>
<pre class="code"><span style="color:blue;">type </span>AuctionMessage =
  | Offer <span style="color:blue;">of </span>int * AsyncAgent <span style="color:green;">// Make a bid
  </span>| Inquire <span style="color:blue;">of </span>AsyncAgent     <span style="color:green;">// Check the status
</span><span style="color:blue;">and </span>AuctionReply =
  | StartBidding
  | Status <span style="color:blue;">of </span>int * DateTime <span style="color:green;">// Asked sum and expiration
  </span>| BestOffer                <span style="color:green;">// Ours is the best offer
  </span>| BeatenOffer <span style="color:blue;">of </span>int       <span style="color:green;">// Yours is beaten by another offer
  </span>| AuctionConcluded <span style="color:blue;">of      </span><span style="color:green;">// Auction concluded
      </span>AsyncAgent * AsyncAgent
  | AuctionFailed            <span style="color:green;">// Failed without any bids
  </span>| AuctionOver              <span style="color:green;">// Bidding is closed
</span><span style="color:blue;">let </span>timeToShutdown = 3000
<span style="color:blue;">let </span>bidIncrement = 10 </pre>
<p>This is the format of the messages that the clients can send and the action agent can reply to. F# is really good at this sort of thing. First, we need an auction agent:</p>
<pre class="code"><span style="color:blue;">let </span>auctionAgent seller minBid closing =
    <span style="color:blue;">let </span>agent = spawnAgent (<span style="color:blue;">fun </span>msg (isConcluded, maxBid, maxBidder) <span style="color:blue;">-&gt;
                            match </span>msg <span style="color:blue;">with
                            </span>| Offer (_, client) <span style="color:blue;">when </span>isConcluded <span style="color:blue;">-&gt;
                                </span>client &lt;-- AuctionOver
                                (isConcluded, maxBid, maxBidder)
                            | Offer(bid, client) <span style="color:blue;">when </span>not(isConcluded) <span style="color:blue;">-&gt;
                                if </span>bid &gt;= maxBid + bidIncrement <span style="color:blue;">then
                                    if </span>maxBid &gt;= minBid <span style="color:blue;">then </span>maxBidder &lt;-- BeatenOffer bid
                                    client &lt;-- BestOffer
                                    (isConcluded, bid, client)
                                <span style="color:blue;">else
                                    </span>client &lt;-- BeatenOffer maxBid
                                    (isConcluded, maxBid, maxBidder)
                            | Inquire client    <span style="color:blue;">-&gt;
                                </span>client &lt;-- Status(maxBid, closing)
                                (isConcluded, maxBid, maxBidder))
                            (<span style="color:blue;">false</span>, (minBid - bidIncrement), spawnWorker (<span style="color:blue;">fun </span>_ <span style="color:blue;">-&gt; </span>()))                             </pre>
<p>Notice that, if the action is concluded, the agent replies to offers by sending an <em>AuctionOver</em> message. If the auction is still open, then, in case the bid is higher than the max, it sets a new max and notify the two parties involved; otherwise it notifies the bidder that the offer wasn’t successful. Also you can ask for the status of the auction.</p>
<p>This is what the code above says. Maybe the code is simpler than words. Anyhow, we need to treat the case where no message is received for some amount of time.</p>
<pre class="code">agent &lt;-- SetTimeoutHandler
            (closing - DateTime.Now).Milliseconds
            (<span style="color:blue;">fun </span>(isConcluded: bool, maxBid, maxBidder) <span style="color:blue;">-&gt;
                if </span>maxBid &gt;= minBid <span style="color:blue;">then
                  let </span>reply = AuctionConcluded(seller, maxBidder)
                  maxBidder &lt;-- reply
                  seller &lt;-- reply
                <span style="color:blue;">else </span>seller &lt;-- AuctionFailed
                agent &lt;-- SetTimeoutHandler
                    timeToShutdown
                    (<span style="color:blue;">fun </span>(_:bool, _:int,_:AsyncAgent) <span style="color:blue;">-&gt; </span>StopProcessing)
                ContinueProcessing (<span style="color:blue;">true</span>, maxBid, maxBidder))
agent            </pre>
<p>We start by waiting for the amount of time to the closing of the auction. If we get no messages, then two things might happen: we have an offer that is more than the minimum or we don’t. If we do, we tell everyone that it’s finished. Otherwise, we tell the seller that its item wasn’t successful.  In any case, we prepare the agent to shutdown by setting its next timeout to be <em>timeoutToShutdown</em>.</p>
<p>It is interesting that we set the timeout handler inside the timeout handler. This is not a problem because of the nature of message processing (aka it processes one message at the time).</p>
<p>We then need a bunch of of symbols …</p>
<pre class="code"><span style="color:blue;">module </span>Auction =
  <span style="color:blue;">let </span>random = <span style="color:blue;">new </span>Random()
  <span style="color:blue;">let </span>minBid = 100
  <span style="color:blue;">let </span>closing = DateTime.Now.AddMilliseconds 10000.
  <span style="color:blue;">let </span>seller = spawnWorker (<span style="color:blue;">fun </span>(msg:AuctionReply) <span style="color:blue;">-&gt; </span>())
  <span style="color:blue;">let </span>auction = auctionAgent seller minBid closing</pre>
<p>Not a very smart seller we have here … Next up is our definition of a client.</p>
<pre class="code"><span style="color:blue;">let rec </span>c = spawnAgent (
                <span style="color:blue;">fun </span>msg (max, current) <span style="color:blue;">-&gt;
                    let </span>processBid (aMax, aCurrent) =
                        <span style="color:blue;">if </span>aMax &gt;= top <span style="color:blue;">then
                            </span>log <span style="color:maroon;">"too high for me"
                            </span>(aMax, aCurrent)
                        <span style="color:blue;">elif </span>aCurrent &lt; aMax <span style="color:blue;">then
                              let </span>aCurrent = aMax + increment
                              Thread.Sleep (1 + random.Next 1000)
                              auction &lt;-- Offer(aCurrent, c)
                              (aMax, aCurrent)
                        <span style="color:blue;">else </span>(aMax, aCurrent)
                    <span style="color:blue;">match </span>msg <span style="color:blue;">with
                    </span>| StartBidding      <span style="color:blue;">-&gt;
                        </span>auction &lt;-- Inquire c
                        (max, current)
                    | Status(maxBid,_)  <span style="color:blue;">-&gt;
                        </span>log &lt;| sprintf <span style="color:maroon;">"status(%d)" </span>maxBid
                        <span style="color:blue;">let </span>s = processBid (maxBid, current)
                        c &lt;-- SetTimeoutHandler timeToShutdown (<span style="color:blue;">fun </span>_ <span style="color:blue;">-&gt; </span>StopProcessing)
                        s
                    | BestOffer <span style="color:blue;">-&gt;
                        </span>log &lt;| sprintf <span style="color:maroon;">"bestOffer(%d)" </span>current
                        processBid(max, current)
                    | BeatenOffer maxBid <span style="color:blue;">-&gt;
                        </span>log &lt;| sprintf <span style="color:maroon;">"beatenOffer(%d)" </span>maxBid
                        processBid(maxBid, current)
                    | AuctionConcluded(seller, maxBidder) <span style="color:blue;">-&gt;
                        </span>log <span style="color:maroon;">"auctionConcluded"
                        </span>c &lt;-- Stop
                        (max, current)
                    | AuctionOver <span style="color:blue;">-&gt;
                        </span>log <span style="color:maroon;">"auctionOver"
                        </span>c &lt;-- Stop
                        (max, current))
                 (0,0)
c</pre>
<p>Something that I like about agents is the fact that you need to understand just small snippets of code at the time. For example, you can read the processing for BestOffer and figure out if it makes sense.  I have an easy time personalizing them as in : “Ok, the guy just got a notification that there has been a better offer, what is he going to do next?”.</p>
<p>The code should be self explanatory for the most part. In essence, if you can offer more, do it otherwise wait for the auction to end. I’m not even sure the processing is completely right. I confess I’m just trying to do the same as Matthews code from the link above.</p>
<p>We can then start up the whole thing and enjoy the cool output.</p>
<pre class="code"><span style="color:blue;">open </span>Auction
(client 1 20 200) &lt;-- StartBidding
(client 2 10 300) &lt;-- StartBidding
(client 3 30 150) &lt;-- StartBidding
Console.ReadLine() |&gt; ignore  </pre>
<p>Now for the nasty part. Implementing the framework.</p>



  
  <div id="disqus-container">
  
    <button id="disqus-button" onclick="showComments()">Show comments</button>
    <div id="disqus-comments">
      
      
      
        <div id="disqus_thread">
        </div>
        <script type="application/javascript">
          function showComments() {
            var disqus_config = function () {
};
// Build and append comments 
var d = document;
var s = d.createElement('script');
s.async = true;
s.src = '//' + "lucabol" + '.disqus.com/embed.js';
s.setAttribute('data-timestamp', + new Date());
(d.head || d.body).appendChild(s);
            // Remove button
var disqusButton = document.getElementById('disqus-button');
disqusButton.parentNode.removeChild(disqusButton); 
// Un-hide comments
var disqusComments = document.getElementById('disqus-comments');
disqusComments.style.display = 'block'; 
          }
        </script>
      
      <noscript>Enable JavaScript to view Disqus comments.</noscript>
    </div>
  
</div>




    </main>

    <aside id="sidebar-left">
        
<div id="tags">
  <header>
    <h1>Tags</h1>
      
    <h2>¶</h2>
    
  </header>
  
    
    <nav>
      <ul>
        
            <li><a href="../../MyBlog/tags/fsharp">fsharp</a></li>
        
      </ul>
    </nav>
    
  
</div>

    </aside>

    <aside id="sidebar-right">
        <section id="TOC">
        
  
    <header>
        <h1>Table of contents</h1>
        <h2>¶</h2>
    </header>
    


        </section>
    </aside>

    <a id="to_top" href="#top">Top</a>
    <footer>
        
    </footer>

    <script>
    const th = document.querySelector("#theme")
    th.addEventListener("click", e => {
        const x = document.querySelector(".dropdown-content")
        if (x.style.display === "block") {
            x.removeAttribute("style")
        } else {
            x.style.display = "block";
        }
    })
    const children = document.querySelectorAll(".font-name")
    const allStyles = Array.from(children).map(c => c.dataset.classname)

    const defaultStyle = "TimesNewRoman"
    const retrievedStyle = localStorage.getItem("Style")
    const style = allStyles.includes(retrievedStyle) ? retrievedStyle : defaultStyle
    document.body.className = style;

    const fontEl = document.querySelector(".dropdown-content")
    fontEl.addEventListener("click", e => {
        const el = e.target
        const style = el.dataset.classname
        document.body.className = style;
        localStorage.setItem("Style", style)
    })



</script>
    <script>
const init = () => {

    
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    
    window.ga = window.ga || ((...args) => (ga.q = ga.q || []).push(args));

    ga('create', 'UA-133194891-1', 'auto');
    ga('set', 'transport', 'beacon');
    ga('send', 'pageview');
};


window.addEventListener('load', init);
</script>
    <script>
    if("serviceWorker" in navigator){
        navigator.serviceWorker.register("/sw.js");
    }
</script>
    <script>
    window.addEventListener('offline', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.add("show")
        window.caches.keys().then(strikeNonCached)
    })
    window.addEventListener('online', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.remove("show")

        const as = document.querySelectorAll('main a')
        for(const a of as)
            a.classList.remove('strike')
    })

    const strikeNonCached = cacheKeys => {
        caches.open(cacheKeys[0]).then(cache =>
            cache.keys().then(keys => {
                const as = document.querySelectorAll('main a')
                const urls = keys.map(k => k.url)
                for(const a of as)
                    if(urls.indexOf(a.href) === -1)    
                        a.classList.add('strike')
    }))}

    if(navigator.onLine)
        window.dispatchEvent(new Event('online'))
    else
        window.dispatchEvent(new Event('offline'))

</script>
    <script>
function variableResize() {

  
  let bodyStyles = window.getComputedStyle(document.body);	
	
  let root = document.documentElement;
	
	
	const maxWindowSize = bodyStyles.getPropertyValue('--bp-xlarge') * 16;
	const minWindowSize = bodyStyles.getPropertyValue('--bp-small') * 16;
	
	
	const windowWidth = window.innerWidth
	
  
  const pWidthVar = '--p-wdth';
	const pMinFontWidth = bodyStyles.getPropertyValue('--p-wdth-min');
	const pMaxFontWidth = bodyStyles.getPropertyValue('--p-wdth-max');
	scale(pWidthVar, pMinFontWidth, pMaxFontWidth);

  const pWeightVar = '--p-wght';
	const pMinFontWeight = bodyStyles.getPropertyValue('--p-wght-min');
	const pMaxFontWeight = bodyStyles.getPropertyValue('--p-wght-max');
	scale(pWeightVar, pMinFontWeight, pMaxFontWeight);
	
  const h1WidthVar = '--h1-wdth';
	const h1MinFontWidth = bodyStyles.getPropertyValue('--h1-wdth-min');
	const h1MaxFontWidth = bodyStyles.getPropertyValue('--h1-wdth-max');
	scale(h1WidthVar, h1MinFontWidth, h1MaxFontWidth);

  const h1WeightVar = '--h1-wght';
	const h1MinFontWeight = bodyStyles.getPropertyValue('--h1-wght-min');
	const h1MaxFontWeight = bodyStyles.getPropertyValue('--h1-wght-max');
	scale(h1WeightVar, h1MinFontWeight, h1MaxFontWeight);
	
  const h2WidthVar = '--h2-wdth';
	const h2MinFontWidth = bodyStyles.getPropertyValue('--h2-wdth-min');
	const h2MaxFontWidth = bodyStyles.getPropertyValue('--h2-wdth-max');
	scale(h2WidthVar, h2MinFontWidth, h2MaxFontWidth);

  const h2WeightVar = '--h2-wght';
	const h2MinFontWeight = bodyStyles.getPropertyValue('--h2-wght-min');
	const h2MaxFontWeight = bodyStyles.getPropertyValue('--h2-wght-max');
	scale(h2WeightVar, h2MinFontWeight, h2MaxFontWeight);
	
	function scale(varName, minValue, maxValue) {
		
		minValue = minValue * 1;
		maxValue = maxValue * 1;

		
		const percent = (windowWidth - minWindowSize) / (maxWindowSize - minWindowSize);
		if (maxValue < minValue) {
			var valueScale = minValue - (percent * (minValue - maxValue));
		} else {
			var valueScale = (percent * (maxValue - minValue)) + minValue;
		}
	  
		
		const newValue = windowWidth > maxWindowSize
		   ? maxValue 
		   : windowWidth < minWindowSize 
				? minValue 
				: valueScale;
	   
		
		root.style.setProperty(varName, newValue);
	}
}

window.addEventListener("load", variableResize);
window.addEventListener("resize", variableResize);

</script>
    <script>
  const el = document.querySelector("#to_nav")
  el.addEventListener("click", e => {
    const x = document.querySelector("#primary_nav")
    if (x.style.display === "block") {
      x.removeAttribute("style")
    } else {
      x.style.display = "block";
    }
  })
  window.addEventListener('click', e => {
    const x = document.querySelector("#primary_nav")
    const y = document.querySelector("#to_nav")
    if (!y.contains(e.target) && x.style.display === "block") {
      x.removeAttribute("style")
    } 

    const th = document.querySelector("#theme")
    const x1 = document.querySelector(".dropdown-content")

    if (!th.contains(e.target) && ! x1.contains(e.target) && x1.style.display === "block") {
      x1.removeAttribute("style")
    } 
  })
</script>

</body>
</html>