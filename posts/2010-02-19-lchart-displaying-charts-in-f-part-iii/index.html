<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff"/>


<meta name="description" content="The last post is here. In this post we’ll look at how things work under the cover and to why I came to believe that they shouldn’t work this way.
First of all each one of the functions to create charts looks something like this:
static member bar (?y,?x, ?isValueShownAsLabel, ?markerSize, ?markerStyle, ?color, ?xname, ?yname, ?seriesName, ?title, ?drawingStyle) = let c = Create (SeriesChartType.Bar, x, y, isValueShownAsLabel, markerSize, markerStyle, color, xname, yname, seriesName, title) c.">





<link rel="preload" href="../../fonts/SourceSerifVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../fonts/SourceSansVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<link rel="stylesheet" href="../../css/base.css"> 
<link rel="stylesheet" href="../../css/fonts.css">


  <link rel="preload" href="../../fonts/SourceCodeVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceCodeVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceSerifVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">



  <title>LChart: displaying charts in F# – Part III | Lucabol blog</title>


<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../site.webmanifest">
    </head>
<body>
    <header>
        <div id="topnav">
            <a id="logo" href="../../">❧</a>
            
                <time id="blog_date" > 2010/02/02</time>
            
            <span class="offline">~~ Offline ~~</span>
            <span class="rightnav">
                <a id="theme">theme</a><div class="dropdown-content">
          <a class="font-name" data-classname="OpenDyslexic" >0. OpenDyslexic</a>
          <a class="font-name" data-classname="Cardo" >1. Se Old Style: Cardo (Minion, Gallard, Centaur)</a>
          <a class="font-name" data-classname="CrimsonPro" >1. Se Old Style: Crimson Pro (Century, Palatino, Plantin, Sabon)</a>
          <a class="font-name" data-classname="EBGaramond" >1. Se Old Style: Garamond</a>
          <a class="font-name" data-classname="Gentium" >1. Se Old Style: Gentium</a>
          <a class="font-name" data-classname="GoudyStM" >1. Se Old Style: Sorts Mill Goudy</a>
          <a class="font-name" data-classname="LibreBaskerville" >4. Se Transitional: Libre Bask. (Mrs Eaves)</a>
          <a class="font-name" data-classname="LibreCaslon" >4. Se Transitional: Libre Caslon</a>
          <a class="font-name" data-classname="PT" >4. Se Transitional: PT fonts (Le Monde)</a>
          <a class="font-name" data-classname="SourcePro" >4. Se Transitional: Source Pro (Skolar, Fournier)</a>
          <a class="font-name" data-classname="TimesNewRoman" >4. Se Transitional: Times New Roman</a>
          <a class="font-name" data-classname="CM" >5. Se Didone: Computer Modern</a>
          <a class="font-name" data-classname="OldStandardTT" >5. Se Didone: Old Standard TT (Filosofia, Scotch Modern)</a>
          <a class="font-name" data-classname="STIX2" >5. Se Didone: Stix2</a>
          <a class="font-name" data-classname="Charter" >6. Se Scotch: Charter</a>
          <a class="font-name" data-classname="Georgia" >6. Se Scotch: Georgia</a>
          <a class="font-name" data-classname="WorkSans" >8. Sa Grotesque: Work Sans (All Grotesque, FF Bau, Venus)</a>
          <a class="font-name" data-classname="AntiqueOlive" >9. Sa Geometric: Antique Oliv</a>
          <a class="font-name" data-classname="bahnschrift" >9. Sa Geometric: Bahnschrift</a>
          <a class="font-name" data-classname="CooperHewitt" >9. Sa Geometric: Cooper Hewitt (Calibre)</a>
          <a class="font-name" data-classname="SourceSans" >9. Sa Humanist: Source Sans (Balto, Adelle Sans)</a>
          <a class="font-name" data-classname="URWClassico" >9. Sa Humanist: URW Classico (Optima)</a>
          <a class="font-name" data-classname="FiraSans" >a. Sa Humanist: Fira Sans (FF Meta)</a>
          <a class="font-name" data-classname="Nimbus" >a. Sa Humanist: Nimbus (Helvetica)</a>
          <a class="font-name" data-classname="Roboto" >a. Sa Humanist: Roboto (DIN</a>
          <a class="font-name" data-classname="Munson" >b. Sl Grotesque: Munson (Clarendon)</a>
          <a class="font-name" data-classname="Sanchez" >c. Sl Geometric: Sanchez (Rockwell)</a>
          <a class="font-name" data-classname="Enriqueta" >d. Sl Humanist: Enriqueta (PMN Caecilia)</a>
          <a class="font-name" data-classname="Merriweather" >d. Sl Humanist: Merriweather (Chapparal)</a>
          <a class="font-name" data-classname="profont" >Z. Sa Monospace: Profont</a>
</div>
                <a id="to_nav">Menu</a>
                <nav id="primary_nav">
                    

  <a href="../../MyBlog/">home</a>
  <a href="../../MyBlog/tags/">tags</a>
  <a href="https://www.github.com/lucabol">github</a>
  <a href="https://www.linkedin.com/in/lucabolognese/">linkdin</a>
  <a href="../../MyBlog/search">search</a>
  <a href="../../MyBlog/index.xml">rss</a>
                </nav>
            </span>
        </div>
    <h1 id="title">
    
        LChart: displaying charts in F# – Part III
    
    </h1>

    </header>

    <main>
        

<p>The last post is <a href="../../2010/02/17/lchart-displaying-charts-in-f-part-ii/">here</a>. In this post we’ll look at how things work under the cover and to why I came to believe that they shouldn’t work this way.</p>
<p>First of all each one of the functions to create charts looks something like this:</p>
<pre class="code"><span style="color:blue;">static member </span>bar (?y,?x, ?isValueShownAsLabel, ?markerSize, ?markerStyle, ?color, ?xname, ?yname, ?seriesName, ?title, ?drawingStyle) =
    <span style="color:blue;">let </span>c = Create (SeriesChartType.Bar, x, y, isValueShownAsLabel, markerSize, markerStyle, color, xname, yname, seriesName, title)
    c.Series.[0].[<span style="color:maroon;">"DrawingStyle"</span>] &lt;- defaultArg drawingStyle (c.Series.[0].[<span style="color:maroon;">"DrawingStyle"</span>])
    c</pre>
<p>This returns an object of type <em>lc</em> (this is the type of ‘<em>c’</em>). But <em>lc</em> inherits from <em>Chart</em> which is the main class in the Microsoft Chart Controls.</p>
<pre class="code"><span style="color:blue;">type </span>lc() =
    <span style="color:blue;">inherit </span>Chart()</pre>
<p>I should have said at the start that you need to reference such controls.</p>
<pre class="code"><span style="color:blue;">#r </span><span style="color:maroon;">"System.Windows.Forms.DataVisualization.dll"
</span><span style="color:blue;">open </span>System.Collections
<span style="color:blue;">open </span>System.Drawing
<span style="color:blue;">open </span>System.IO
<span style="color:blue;">open </span>System.Windows.Forms
<span style="color:blue;">open </span>System.Windows.Forms.DataVisualization.Charting
<span style="color:blue;">open </span>System.Windows.Forms.DataVisualization.Charting.Utilities
<span style="color:blue;">open </span>System</pre>
<p>It is convenient that the return value of each function is a subtype of <em>Chart</em>. You can then go and customize this object as you like (i.e. changing graphical appearance) before calling <em>display</em>. Given the <em>Chart</em> inherits from <em>Control</em> you can code the display method as follows:</p>
<pre class="code"><span style="color:blue;">let </span>display (c:lc) =
    <span style="color:blue;">let </span>copy () =
        <span style="color:blue;">let </span>stream = <span style="color:blue;">new </span>MemoryStream()
        c.SaveImage(stream, Imaging.ImageFormat.Bmp)
        <span style="color:blue;">let </span>bmp = <span style="color:blue;">new </span>Bitmap(stream)
        Clipboard.SetDataObject(bmp)
    c.KeyDown.Add(<span style="color:blue;">fun </span>e <span style="color:blue;">-&gt; if </span>e.Control = <span style="color:blue;">true </span>&& e.KeyCode = Keys.C <span style="color:blue;">then </span>copy ())
    <span style="color:blue;">let </span>pressToCopy = <span style="color:maroon;">"(press CTRL+C to copy)"
    </span><span style="color:blue;">let </span>name = <span style="color:blue;">if </span>c.Titles.Count = 0 <span style="color:blue;">then </span>sprintf <span style="color:maroon;">"%s %s " "lc" </span>pressToCopy <span style="color:blue;">else </span>sprintf <span style="color:maroon;">"%s %s " </span>c.Titles.[0].Text  pressToCopy
    <span style="color:blue;">let </span>f = <span style="color:blue;">new </span>Form(Text = name, Size = <span style="color:blue;">new </span>Size(800,600), TopMost = <span style="color:blue;">true</span>)
    c.Dock &lt;- DockStyle.Fill
    f.Controls.Add(c)
    f.Show()
    c</pre>
<p>Apart from a bit of convolutions to implement a Copy function, this just put the <em>Chart</em> control on a newly created <em>Form</em>. The <em>Create</em> method called inside <em>bar</em> looks like the following.</p>
<pre class="code"><span style="color:blue;">static let </span>Create (chartType, x, y, isValueShownAsLabel, markerSize, markerStyle, color, xname, yname, seriesName, title) =
    <span style="color:blue;">let </span>c = <span style="color:blue;">new </span>lc()
    <span style="color:blue;">let </span>a = <span style="color:blue;">new </span>ChartArea()
    <span style="color:blue;">let </span>s = <span style="color:blue;">new </span>Series()
    s.ChartType &lt;- chartType
    c.ChartAreas.Add(a)
    c.Series.Add(s)
    <span style="color:blue;">match </span>x, y <span style="color:blue;">with
        </span>| Some(x), None     <span style="color:blue;">-&gt; </span>failwith <span style="color:maroon;">"You cannot pass only x to a chart drawing function"
        </span>| Some(x), Some(y)  <span style="color:blue;">-&gt; </span>s.Points.DataBindXY(x, [|y|])
        | None, Some(y)     <span style="color:blue;">-&gt; </span>s.Points.DataBindY([|y|])
        | None, None        <span style="color:blue;">-&gt; </span>()
    s.IsValueShownAsLabel &lt;- defaultArg isValueShownAsLabel s.IsValueShownAsLabel
    s.MarkerSize &lt;- defaultArg markerSize s.MarkerSize
    s.MarkerStyle &lt;- defaultArg markerStyle s.MarkerStyle
    s.Color &lt;- defaultArg color s.Color
    a.AxisX.MajorGrid.Enabled &lt;- <span style="color:blue;">false
    </span>a.AxisY.MajorGrid.Enabled &lt;- <span style="color:blue;">false
    match </span>xname <span style="color:blue;">with
    </span>| Some(xname) <span style="color:blue;">-&gt;
        </span>a.AxisX.Title &lt;- xname
        a.AxisX.TitleFont &lt;- axisFont
        a.AxisX.TitleForeColor &lt;- axisColor
    | _ <span style="color:blue;">-&gt; </span>()
    <span style="color:blue;">match </span>yname <span style="color:blue;">with
    </span>| Some(yname) <span style="color:blue;">-&gt;
        </span>a.AxisY.Title &lt;- yname
        a.AxisY.TitleFont &lt;- axisFont
        a.AxisY.TitleForeColor &lt;- axisColor
    | _ <span style="color:blue;">-&gt; </span>()
    <span style="color:blue;">match </span>seriesName <span style="color:blue;">with
    </span>| Some(seriesName) <span style="color:blue;">-&gt; </span>s.Name &lt;- seriesName
    | _ <span style="color:blue;">-&gt; </span>()
    <span style="color:blue;">match </span>title <span style="color:blue;">with
    </span>| Some(title) <span style="color:blue;">-&gt;
        let </span>t = c.Titles.Add(title: string)
        t.Font &lt;- titleFont
        t.ForeColor &lt;- titleColor
    | _ <span style="color:blue;">-&gt; </span>()
    c</pre>
<p>Pretty standard imperative code here. Creating a chart and assigning its properties. Read the documentation for the Chart Control to understand what I’m doing here. I’m not even sure I remember what I’m doing. Given that we have our own <em>lc</em> class (which is a type of <em>Chart</em>) we can then override the ‘+’ operator and ‘++’ operator to do what is needed.</p>
<pre class="code"><span style="color:blue;">static member </span>(+) (c1:lc, c2:lc) =
    <span style="color:blue;">let </span>c = copyChart(c1)
    c1.ChartAreas |&gt; Seq.iter (<span style="color:blue;">fun </span>a <span style="color:blue;">-&gt; </span>addAreaAndSeries c a c1.Series)
    <span style="color:blue;">let </span>lastArea = c.ChartAreas |&gt; Seq.nth ((c.ChartAreas |&gt; Seq.length) - 1)
    c2.Series |&gt; Seq.iter(<span style="color:blue;">fun </span>s <span style="color:blue;">-&gt; </span>c.Series.Add(copySeries s c lastArea.Name))
    <span style="color:blue;">let </span>l = c.Legends.Add(<span style="color:maroon;">""</span>)
    l.Font &lt;- legendFont
    c
<span style="color:blue;">static member </span>(++) (c1:lc, c2:lc) =
    <span style="color:blue;">let </span>c = copyChart(c1)
    c1.ChartAreas |&gt; Seq.iter (<span style="color:blue;">fun </span>a <span style="color:blue;">-&gt; </span>addAreaAndSeries c a c1.Series)
    <span style="color:blue;">let </span>lastArea = c.ChartAreas |&gt; Seq.nth ((c.ChartAreas |&gt; Seq.length) - 1)
    addAreaAndSeries c c2.ChartAreas.[0] c2.Series
    <span style="color:blue;">let </span>firstArea = c.ChartAreas |&gt; Seq.nth ((c.ChartAreas |&gt; Seq.length) - 1)
    c2.ChartAreas |&gt; Seq.skip 1 |&gt; Seq.iter (<span style="color:blue;">fun </span>a <span style="color:blue;">-&gt; </span>addAreaAndSeries c a c2.Series)
    c    </pre>
<p>Apart from some other utility functions, this is how it all works. Why do I say that it is wrong? It is my opinion that the right way to do it would be to use <em>‘+</em>’, ‘<em>++</em>’ and all the <em>lc.XXX</em> functions to create an object model that is completely independent from the Microsoft Chart controls. The display method would then translate it to the appropriate displayable Chart. It would work like a compiler translating to IL and then a Jitter producing native code. This would:</p>
<ul>
<li>Make possible to do more interesting compositions of graphs. Now I’m very constrained in what I can do by the fact that I’m working directly with Chart objects</li>
<li>Make possible to change the backend. Using something different than Microsoft Chart controls to draw the chart</li>
</ul>
<p>Why I have not done it? I didn’t know that was the right design until I used the wrong one. Now that I know, I have no time to do it.</p>



  
  <div id="disqus-container">
  
    <button id="disqus-button" onclick="showComments()">Show comments</button>
    <div id="disqus-comments">
      
      
      
        <div id="disqus_thread">
        </div>
        <script type="application/javascript">
          function showComments() {
            var disqus_config = function () {
};
// Build and append comments 
var d = document;
var s = d.createElement('script');
s.async = true;
s.src = '//' + "lucabol" + '.disqus.com/embed.js';
s.setAttribute('data-timestamp', + new Date());
(d.head || d.body).appendChild(s);
            // Remove button
var disqusButton = document.getElementById('disqus-button');
disqusButton.parentNode.removeChild(disqusButton); 
// Un-hide comments
var disqusComments = document.getElementById('disqus-comments');
disqusComments.style.display = 'block'; 
          }
        </script>
      
      <noscript>Enable JavaScript to view Disqus comments.</noscript>
    </div>
  
</div>




    </main>

    <aside id="sidebar-left">
        
<div id="tags">
  <header>
    <h1>Tags</h1>
      
    <h2>¶</h2>
    
  </header>
  
    
    <nav>
      <ul>
        
            <li><a href="../../MyBlog/tags/fsharp">fsharp</a></li>
        
      </ul>
    </nav>
    
  
</div>

    </aside>

    <aside id="sidebar-right">
        <section id="TOC">
        
  
    <header>
        <h1>Table of contents</h1>
        <h2>¶</h2>
    </header>
    


        </section>
    </aside>

    <a id="to_top" href="#top">Top</a>
    <footer>
        
    </footer>

    <script>
    const th = document.querySelector("#theme")
    th.addEventListener("click", e => {
        const x = document.querySelector(".dropdown-content")
        if (x.style.display === "block") {
            x.removeAttribute("style")
        } else {
            x.style.display = "block";
        }
    })
    const children = document.querySelectorAll(".font-name")
    const allStyles = Array.from(children).map(c => c.dataset.classname)

    const defaultStyle = "TimesNewRoman"
    const retrievedStyle = localStorage.getItem("Style")
    const style = allStyles.includes(retrievedStyle) ? retrievedStyle : defaultStyle
    document.body.className = style;

    const fontEl = document.querySelector(".dropdown-content")
    fontEl.addEventListener("click", e => {
        const el = e.target
        const style = el.dataset.classname
        document.body.className = style;
        localStorage.setItem("Style", style)
    })



</script>
    <script>
const init = () => {

    
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    
    window.ga = window.ga || ((...args) => (ga.q = ga.q || []).push(args));

    ga('create', 'UA-133194891-1', 'auto');
    ga('set', 'transport', 'beacon');
    ga('send', 'pageview');
};


window.addEventListener('load', init);
</script>
    <script>
    if("serviceWorker" in navigator){
        navigator.serviceWorker.register("/sw.js");
    }
</script>
    <script>
    window.addEventListener('offline', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.add("show")
        window.caches.keys().then(strikeNonCached)
    })
    window.addEventListener('online', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.remove("show")

        const as = document.querySelectorAll('main a')
        for(const a of as)
            a.classList.remove('strike')
    })

    const strikeNonCached = cacheKeys => {
        caches.open(cacheKeys[0]).then(cache =>
            cache.keys().then(keys => {
                const as = document.querySelectorAll('main a')
                const urls = keys.map(k => k.url)
                for(const a of as)
                    if(urls.indexOf(a.href) === -1)    
                        a.classList.add('strike')
    }))}

    if(navigator.onLine)
        window.dispatchEvent(new Event('online'))
    else
        window.dispatchEvent(new Event('offline'))

</script>
    <script>
function variableResize() {

  
  let bodyStyles = window.getComputedStyle(document.body);	
	
  let root = document.documentElement;
	
	
	const maxWindowSize = bodyStyles.getPropertyValue('--bp-xlarge') * 16;
	const minWindowSize = bodyStyles.getPropertyValue('--bp-small') * 16;
	
	
	const windowWidth = window.innerWidth
	
  
  const pWidthVar = '--p-wdth';
	const pMinFontWidth = bodyStyles.getPropertyValue('--p-wdth-min');
	const pMaxFontWidth = bodyStyles.getPropertyValue('--p-wdth-max');
	scale(pWidthVar, pMinFontWidth, pMaxFontWidth);

  const pWeightVar = '--p-wght';
	const pMinFontWeight = bodyStyles.getPropertyValue('--p-wght-min');
	const pMaxFontWeight = bodyStyles.getPropertyValue('--p-wght-max');
	scale(pWeightVar, pMinFontWeight, pMaxFontWeight);
	
  const h1WidthVar = '--h1-wdth';
	const h1MinFontWidth = bodyStyles.getPropertyValue('--h1-wdth-min');
	const h1MaxFontWidth = bodyStyles.getPropertyValue('--h1-wdth-max');
	scale(h1WidthVar, h1MinFontWidth, h1MaxFontWidth);

  const h1WeightVar = '--h1-wght';
	const h1MinFontWeight = bodyStyles.getPropertyValue('--h1-wght-min');
	const h1MaxFontWeight = bodyStyles.getPropertyValue('--h1-wght-max');
	scale(h1WeightVar, h1MinFontWeight, h1MaxFontWeight);
	
  const h2WidthVar = '--h2-wdth';
	const h2MinFontWidth = bodyStyles.getPropertyValue('--h2-wdth-min');
	const h2MaxFontWidth = bodyStyles.getPropertyValue('--h2-wdth-max');
	scale(h2WidthVar, h2MinFontWidth, h2MaxFontWidth);

  const h2WeightVar = '--h2-wght';
	const h2MinFontWeight = bodyStyles.getPropertyValue('--h2-wght-min');
	const h2MaxFontWeight = bodyStyles.getPropertyValue('--h2-wght-max');
	scale(h2WeightVar, h2MinFontWeight, h2MaxFontWeight);
	
	function scale(varName, minValue, maxValue) {
		
		minValue = minValue * 1;
		maxValue = maxValue * 1;

		
		const percent = (windowWidth - minWindowSize) / (maxWindowSize - minWindowSize);
		if (maxValue < minValue) {
			var valueScale = minValue - (percent * (minValue - maxValue));
		} else {
			var valueScale = (percent * (maxValue - minValue)) + minValue;
		}
	  
		
		const newValue = windowWidth > maxWindowSize
		   ? maxValue 
		   : windowWidth < minWindowSize 
				? minValue 
				: valueScale;
	   
		
		root.style.setProperty(varName, newValue);
	}
}

window.addEventListener("load", variableResize);
window.addEventListener("resize", variableResize);

</script>
    <script>
  const el = document.querySelector("#to_nav")
  el.addEventListener("click", e => {
    const x = document.querySelector("#primary_nav")
    if (x.style.display === "block") {
      x.removeAttribute("style")
    } else {
      x.style.display = "block";
    }
  })
  window.addEventListener('click', e => {
    const x = document.querySelector("#primary_nav")
    const y = document.querySelector("#to_nav")
    if (!y.contains(e.target) && x.style.display === "block") {
      x.removeAttribute("style")
    } 

    const th = document.querySelector("#theme")
    const x1 = document.querySelector(".dropdown-content")

    if (!th.contains(e.target) && ! x1.contains(e.target) && x1.style.display === "block") {
      x1.removeAttribute("style")
    } 
  })
</script>

</body>
</html>