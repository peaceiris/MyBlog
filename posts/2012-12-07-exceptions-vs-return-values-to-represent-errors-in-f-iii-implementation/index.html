<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff"/>


<meta name="description" content="The Critical monad is defined as follows. First there is the type that propagates through the monad:
type Result&amp;lt;&#39;a, &#39;b&amp;gt; = | Success of &#39;a | Failure of &#39;b Then we define the usual computation expression methods.
type Critical() = // a -&amp;gt; m a member o.Return x = Success x // m a -&amp;gt; (a -&amp;gt; m b) -&amp;gt; m b member o.Bind (m, f) = match m with | Failure e -&amp;gt; Failure e | Success x -&amp;gt; f x // m a -&amp;gt; m a member o.">





<link rel="preload" href="../../fonts/SourceSerifVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../fonts/SourceSansVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<link rel="stylesheet" href="../../css/base.css"> 
<link rel="stylesheet" href="../../css/fonts.css">


  <link rel="preload" href="../../fonts/SourceCodeVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceCodeVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceSerifVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">



  <title>Exceptions vs. Return Values to represent errors (in F#) – IV – Implementation | Lucabol blog</title>


<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../site.webmanifest">
    </head>
<body>
    <header>
        <div id="topnav">
            <a id="logo" href="../../">❧</a>
            
                <time id="blog_date" > 2012/12/12</time>
            
            <span class="offline">~~ Offline ~~</span>
            <span class="rightnav">
                <a id="theme">theme</a><div class="dropdown-content">
          <a class="font-name" data-classname="OpenDyslexic" >0. OpenDyslexic</a>
          <a class="font-name" data-classname="Cardo" >1. Se Old Style: Cardo (Minion, Gallard, Centaur)</a>
          <a class="font-name" data-classname="CrimsonPro" >1. Se Old Style: Crimson Pro (Century, Palatino, Plantin, Sabon)</a>
          <a class="font-name" data-classname="EBGaramond" >1. Se Old Style: Garamond</a>
          <a class="font-name" data-classname="Gentium" >1. Se Old Style: Gentium</a>
          <a class="font-name" data-classname="GoudyStM" >1. Se Old Style: Sorts Mill Goudy</a>
          <a class="font-name" data-classname="LibreBaskerville" >4. Se Transitional: Libre Bask. (Mrs Eaves)</a>
          <a class="font-name" data-classname="LibreCaslon" >4. Se Transitional: Libre Caslon</a>
          <a class="font-name" data-classname="PT" >4. Se Transitional: PT fonts (Le Monde)</a>
          <a class="font-name" data-classname="SourcePro" >4. Se Transitional: Source Pro (Skolar, Fournier)</a>
          <a class="font-name" data-classname="TimesNewRoman" >4. Se Transitional: Times New Roman</a>
          <a class="font-name" data-classname="CM" >5. Se Didone: Computer Modern</a>
          <a class="font-name" data-classname="OldStandardTT" >5. Se Didone: Old Standard TT (Filosofia, Scotch Modern)</a>
          <a class="font-name" data-classname="STIX2" >5. Se Didone: Stix2</a>
          <a class="font-name" data-classname="Charter" >6. Se Scotch: Charter</a>
          <a class="font-name" data-classname="Georgia" >6. Se Scotch: Georgia</a>
          <a class="font-name" data-classname="WorkSans" >8. Sa Grotesque: Work Sans (All Grotesque, FF Bau, Venus)</a>
          <a class="font-name" data-classname="AntiqueOlive" >9. Sa Geometric: Antique Oliv</a>
          <a class="font-name" data-classname="bahnschrift" >9. Sa Geometric: Bahnschrift</a>
          <a class="font-name" data-classname="CooperHewitt" >9. Sa Geometric: Cooper Hewitt (Calibre)</a>
          <a class="font-name" data-classname="SourceSans" >9. Sa Humanist: Source Sans (Balto, Adelle Sans)</a>
          <a class="font-name" data-classname="URWClassico" >9. Sa Humanist: URW Classico (Optima)</a>
          <a class="font-name" data-classname="FiraSans" >a. Sa Humanist: Fira Sans (FF Meta)</a>
          <a class="font-name" data-classname="Nimbus" >a. Sa Humanist: Nimbus (Helvetica)</a>
          <a class="font-name" data-classname="Roboto" >a. Sa Humanist: Roboto (DIN</a>
          <a class="font-name" data-classname="Munson" >b. Sl Grotesque: Munson (Clarendon)</a>
          <a class="font-name" data-classname="Sanchez" >c. Sl Geometric: Sanchez (Rockwell)</a>
          <a class="font-name" data-classname="Enriqueta" >d. Sl Humanist: Enriqueta (PMN Caecilia)</a>
          <a class="font-name" data-classname="Merriweather" >d. Sl Humanist: Merriweather (Chapparal)</a>
          <a class="font-name" data-classname="profont" >Z. Sa Monospace: Profont</a>
</div>
                <a id="to_nav">Menu</a>
                <nav id="primary_nav">
                    

  <a href="../../MyBlog/">home</a>
  <a href="../../MyBlog/tags/">tags</a>
  <a href="https://www.github.com/lucabol">github</a>
  <a href="https://www.linkedin.com/in/lucabolognese/">linkdin</a>
  <a href="../../MyBlog/search">search</a>
  <a href="../../MyBlog/index.xml">rss</a>
                </nav>
            </span>
        </div>
    <h1 id="title">
    
        Exceptions vs. Return Values to represent errors (in F#) – IV – Implementation
    
    </h1>

    </header>

    <main>
        

<p>The Critical monad is defined as follows. First there is the type that propagates through the monad:</p>
<pre class="code"><span style="background:white;color:blue;">type </span><span style="background:white;color:black;">Result&lt;'a, 'b&gt; =
| Success </span><span style="background:white;color:blue;">of </span><span style="background:white;color:black;">'a
| Failure </span><span style="background:white;color:blue;">of </span><span style="background:white;color:black;">'b</span></pre>
<p>Then we define the usual computation expression methods.</p>
<pre class="code"><span style="background:white;color:blue;">type </span><span style="background:white;color:black;">Critical() =
       </span><span style="background:white;color:green;">// a -&gt; m a
        </span><span style="background:white;color:blue;">member </span><span style="background:white;color:black;">o.Return x       = Success x
        </span><span style="background:white;color:green;">// m a -&gt; (a -&gt; m b) -&gt; m b
        </span><span style="background:white;color:blue;">member </span><span style="background:white;color:black;">o.Bind (m, f)    = </span><span style="background:white;color:blue;">match </span><span style="background:white;color:black;">m </span><span style="background:white;color:blue;">with
                                    </span><span style="background:white;color:black;">| Failure e </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">Failure e
                                    | Success x </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">f x
        </span><span style="background:white;color:green;">// m a -&gt; m a
        </span><span style="background:white;color:blue;">member </span><span style="background:white;color:black;">o.ReturnFrom m   = m</span></pre>
<p>Explaining how computational expressions work in F# is a blog onto itself. And several chapters in many books. Sufficient to say that conceptually this propagates the success value and returns the failure value.</p>
<p>We then define an instance of this type, so that we can use the nice ‘critical { … }’ syntax.</p>
<pre class="code"><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">critical = Critical()
</span></pre>
<p>We then go and define the functions that the user needs to use to annotate their function calls. The simplest one is the one to propagate any exception coming from the function ‘f’.</p>
<pre class="code"><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">fault f = f
</span></pre>
<p>Then it comes the one to manage contingencies. This will trap any exception for which ‘stopF ex’ is ‘true’, call ‘errF ex’ to construct the error return value and wrap it in a ‘Failure’. Otherwise it will rethrow the exception.</p>
<pre class="code"><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">contingentGen stopF errF f =
    </span><span style="background:white;color:blue;">try
        </span><span style="background:white;color:black;">Success(f ())
    </span><span style="background:white;color:blue;">with
        </span><span style="background:white;color:black;">| ex </span><span style="background:white;color:blue;">when </span><span style="background:white;color:black;">stopF ex </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">Failure(errF ex)
        | _                </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">reraise ()
</span></pre>
<p>Albeit very simple, the above is the core of the system. Everything else is just details. Let’s look at them.</p>
<p>First we want a function that takes as parameter a list of (Exception, ReturnValue) and gives back the correct stopF errF to plug into ‘contingentGen’.</p>
<pre class="code"><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">exceptionMapToFuncs exMap =
    </span><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">tryFind ex = exMap |&gt; List.tryFind (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">(k, _) </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">k.GetType() = ex.GetType())
    (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">ex </span><span style="background:white;color:blue;">-&gt;
        let </span><span style="background:white;color:black;">found = tryFind ex
        </span><span style="background:white;color:blue;">match </span><span style="background:white;color:black;">found </span><span style="background:white;color:blue;">with </span><span style="background:white;color:black;">Some(_) </span><span style="background:white;color:blue;">-&gt; true </span><span style="background:white;color:black;">| None </span><span style="background:white;color:blue;">-&gt; false</span><span style="background:white;color:black;">),
    (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">ex </span><span style="background:white;color:blue;">-&gt;
        let </span><span style="background:white;color:black;">found = tryFind ex
        </span><span style="background:white;color:blue;">match </span><span style="background:white;color:black;">found </span><span style="background:white;color:blue;">with
        </span><span style="background:white;color:black;">| Some(k, v)    </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">v ex
        | None          </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">raise ex)
</span></pre>
<p>Then ugliness comes. For the sake of getting a decent syntax (not great) on the calling site, we need to fake overloading of functions by the old trick of adding a number at the end. Thanks to <a href="http://gotocon.com/amsterdam-2012/speaker/Tobias+Gedell">Tobias</a> to point out this (my api was even worse earlier).</p>
<p>I often wondered about the trade-off between currying and overloading for functions. I seem to always paint myself in a situation where I need overloading. In any case, here it goes:</p>
<pre class="code"><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">contingent1 exMap f x =
    </span><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">stopF, errF = exceptionMapToFuncs exMap
    contingentGen stopF errF (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">_ </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">f x)
</span><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">contingent2 exMap f x y =
    </span><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">stopF, errF = exceptionMapToFuncs exMap
    contingentGen stopF errF (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">_ </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">f x y)
</span><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">contingent3 exMap f x y z =
    </span><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">stopF, errF = exceptionMapToFuncs exMap
    contingentGen stopF errF (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">_ </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">f x y z)
</span></pre>
<p>Sometimes you want to trap all exceptions from a function and return your own error value:</p>
<pre class="code"><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">neverThrow1 exc f x     = contingentGen (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">_ </span><span style="background:white;color:blue;">-&gt; true</span><span style="background:white;color:black;">) (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">ex </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">exc ex) (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">_ </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">f x)
</span><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">neverThrow2 exc f x y   = contingentGen (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">_ </span><span style="background:white;color:blue;">-&gt; true</span><span style="background:white;color:black;">) (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">ex </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">exc ex) (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">_ </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">f x y)
</span><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">neverThrow3 exc f x y z = contingentGen (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">_ </span><span style="background:white;color:blue;">-&gt; true</span><span style="background:white;color:black;">) (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">ex </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">exc ex) (</span><span style="background:white;color:blue;">fun </span><span style="background:white;color:black;">_ </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">f x y z)
</span></pre>
<p>Other times you need to go from a function that returns return values to one that throws exceptions. You need translating from contingencies to faults:</p>
<pre class="code"><span style="background:white;color:blue;">let </span><span style="background:white;color:black;">alwaysThrow exc f x =
    </span><span style="background:white;color:blue;">match </span><span style="background:white;color:black;">f x </span><span style="background:white;color:blue;">with
    </span><span style="background:white;color:black;">| Success(ret)              </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">ret
    | Failure(e)                </span><span style="background:white;color:blue;">-&gt; </span><span style="background:white;color:black;">raise (exc e)
</span></pre>
<p>And that’s it. Hopefully we have bridged the gap between exceptions and return values without making the code too ugly (just a little bit). Or perhaps not.</p>
<p>I need to add that I haven’t used this library myself (yet). I’m sure when I do I’ll discover many things to change.</p>



  
  <div id="disqus-container">
  
    <button id="disqus-button" onclick="showComments()">Show comments</button>
    <div id="disqus-comments">
      
      
      
        <div id="disqus_thread">
        </div>
        <script type="application/javascript">
          function showComments() {
            var disqus_config = function () {
};
// Build and append comments 
var d = document;
var s = d.createElement('script');
s.async = true;
s.src = '//' + "lucabol" + '.disqus.com/embed.js';
s.setAttribute('data-timestamp', + new Date());
(d.head || d.body).appendChild(s);
            // Remove button
var disqusButton = document.getElementById('disqus-button');
disqusButton.parentNode.removeChild(disqusButton); 
// Un-hide comments
var disqusComments = document.getElementById('disqus-comments');
disqusComments.style.display = 'block'; 
          }
        </script>
      
      <noscript>Enable JavaScript to view Disqus comments.</noscript>
    </div>
  
</div>




    </main>

    <aside id="sidebar-left">
        
<div id="tags">
  <header>
    <h1>Tags</h1>
      
    <h2>¶</h2>
    
  </header>
  
    
    <nav>
      <ul>
        
            <li><a href="../../MyBlog/tags/fsharp">fsharp</a></li>
        
      </ul>
    </nav>
    
  
</div>

    </aside>

    <aside id="sidebar-right">
        <section id="TOC">
        
  
    <header>
        <h1>Table of contents</h1>
        <h2>¶</h2>
    </header>
    


        </section>
    </aside>

    <a id="to_top" href="#top">Top</a>
    <footer>
        
    </footer>

    <script>
    const th = document.querySelector("#theme")
    th.addEventListener("click", e => {
        const x = document.querySelector(".dropdown-content")
        if (x.style.display === "block") {
            x.removeAttribute("style")
        } else {
            x.style.display = "block";
        }
    })
    const children = document.querySelectorAll(".font-name")
    const allStyles = Array.from(children).map(c => c.dataset.classname)

    const defaultStyle = "TimesNewRoman"
    const retrievedStyle = localStorage.getItem("Style")
    const style = allStyles.includes(retrievedStyle) ? retrievedStyle : defaultStyle
    document.body.className = style;

    const fontEl = document.querySelector(".dropdown-content")
    fontEl.addEventListener("click", e => {
        const el = e.target
        const style = el.dataset.classname
        document.body.className = style;
        localStorage.setItem("Style", style)
    })



</script>
    <script>
const init = () => {

    
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    
    window.ga = window.ga || ((...args) => (ga.q = ga.q || []).push(args));

    ga('create', 'UA-133194891-1', 'auto');
    ga('set', 'transport', 'beacon');
    ga('send', 'pageview');
};


window.addEventListener('load', init);
</script>
    <script>
    if("serviceWorker" in navigator){
        navigator.serviceWorker.register("/sw.js");
    }
</script>
    <script>
    window.addEventListener('offline', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.add("show")
        window.caches.keys().then(strikeNonCached)
    })
    window.addEventListener('online', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.remove("show")

        const as = document.querySelectorAll('main a')
        for(const a of as)
            a.classList.remove('strike')
    })

    const strikeNonCached = cacheKeys => {
        caches.open(cacheKeys[0]).then(cache =>
            cache.keys().then(keys => {
                const as = document.querySelectorAll('main a')
                const urls = keys.map(k => k.url)
                for(const a of as)
                    if(urls.indexOf(a.href) === -1)    
                        a.classList.add('strike')
    }))}

    if(navigator.onLine)
        window.dispatchEvent(new Event('online'))
    else
        window.dispatchEvent(new Event('offline'))

</script>
    <script>
function variableResize() {

  
  let bodyStyles = window.getComputedStyle(document.body);	
	
  let root = document.documentElement;
	
	
	const maxWindowSize = bodyStyles.getPropertyValue('--bp-xlarge') * 16;
	const minWindowSize = bodyStyles.getPropertyValue('--bp-small') * 16;
	
	
	const windowWidth = window.innerWidth
	
  
  const pWidthVar = '--p-wdth';
	const pMinFontWidth = bodyStyles.getPropertyValue('--p-wdth-min');
	const pMaxFontWidth = bodyStyles.getPropertyValue('--p-wdth-max');
	scale(pWidthVar, pMinFontWidth, pMaxFontWidth);

  const pWeightVar = '--p-wght';
	const pMinFontWeight = bodyStyles.getPropertyValue('--p-wght-min');
	const pMaxFontWeight = bodyStyles.getPropertyValue('--p-wght-max');
	scale(pWeightVar, pMinFontWeight, pMaxFontWeight);
	
  const h1WidthVar = '--h1-wdth';
	const h1MinFontWidth = bodyStyles.getPropertyValue('--h1-wdth-min');
	const h1MaxFontWidth = bodyStyles.getPropertyValue('--h1-wdth-max');
	scale(h1WidthVar, h1MinFontWidth, h1MaxFontWidth);

  const h1WeightVar = '--h1-wght';
	const h1MinFontWeight = bodyStyles.getPropertyValue('--h1-wght-min');
	const h1MaxFontWeight = bodyStyles.getPropertyValue('--h1-wght-max');
	scale(h1WeightVar, h1MinFontWeight, h1MaxFontWeight);
	
  const h2WidthVar = '--h2-wdth';
	const h2MinFontWidth = bodyStyles.getPropertyValue('--h2-wdth-min');
	const h2MaxFontWidth = bodyStyles.getPropertyValue('--h2-wdth-max');
	scale(h2WidthVar, h2MinFontWidth, h2MaxFontWidth);

  const h2WeightVar = '--h2-wght';
	const h2MinFontWeight = bodyStyles.getPropertyValue('--h2-wght-min');
	const h2MaxFontWeight = bodyStyles.getPropertyValue('--h2-wght-max');
	scale(h2WeightVar, h2MinFontWeight, h2MaxFontWeight);
	
	function scale(varName, minValue, maxValue) {
		
		minValue = minValue * 1;
		maxValue = maxValue * 1;

		
		const percent = (windowWidth - minWindowSize) / (maxWindowSize - minWindowSize);
		if (maxValue < minValue) {
			var valueScale = minValue - (percent * (minValue - maxValue));
		} else {
			var valueScale = (percent * (maxValue - minValue)) + minValue;
		}
	  
		
		const newValue = windowWidth > maxWindowSize
		   ? maxValue 
		   : windowWidth < minWindowSize 
				? minValue 
				: valueScale;
	   
		
		root.style.setProperty(varName, newValue);
	}
}

window.addEventListener("load", variableResize);
window.addEventListener("resize", variableResize);

</script>
    <script>
  const el = document.querySelector("#to_nav")
  el.addEventListener("click", e => {
    const x = document.querySelector("#primary_nav")
    if (x.style.display === "block") {
      x.removeAttribute("style")
    } else {
      x.style.display = "block";
    }
  })
  window.addEventListener('click', e => {
    const x = document.querySelector("#primary_nav")
    const y = document.querySelector("#to_nav")
    if (!y.contains(e.target) && x.style.display === "block") {
      x.removeAttribute("style")
    } 

    const th = document.querySelector("#theme")
    const x1 = document.querySelector(".dropdown-content")

    if (!th.contains(e.target) && ! x1.contains(e.target) && x1.style.display === "block") {
      x1.removeAttribute("style")
    } 
  })
</script>

</body>
</html>