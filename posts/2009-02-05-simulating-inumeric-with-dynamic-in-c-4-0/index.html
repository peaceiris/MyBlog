<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff"/>


<meta name="description" content="When I wrote my Excel financial library I agonized over the decision of which numeric type to use to represent money. Logic would push me toward decimal, but common usage among financial library writers would push me toward double. I ended up picking double, but I regret having to make that choice in the first place.
Conceptually, I&amp;rsquo;d like my numeric functions to work for anything that supports the basic arithmetic operators (i.">





<link rel="preload" href="../../fonts/SourceSerifVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../fonts/SourceSansVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<link rel="stylesheet" href="../../css/base.css"> 
<link rel="stylesheet" href="../../css/fonts.css">


  <link rel="preload" href="../../fonts/SourceCodeVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceCodeVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceSerifVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">



  <title>Simulating INumeric with dynamic in C# 4.0 | Lucabol blog</title>


<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../site.webmanifest">
    </head>
<body>
    <header>
        <div id="topnav">
            <a id="logo" href="../../">‚ùß</a>
            
                <time id="blog_date" > 2009/02/02</time>
            
            <span class="offline">~~ Offline ~~</span>
            <span class="rightnav">
                <a id="theme">theme</a><div class="dropdown-content">
          <a class="font-name" data-classname="OpenDyslexic" >0. OpenDyslexic</a>
          <a class="font-name" data-classname="Cardo" >1. Se Old Style: Cardo (Minion, Gallard, Centaur)</a>
          <a class="font-name" data-classname="CrimsonPro" >1. Se Old Style: Crimson Pro (Century, Palatino, Plantin, Sabon)</a>
          <a class="font-name" data-classname="EBGaramond" >1. Se Old Style: Garamond</a>
          <a class="font-name" data-classname="Gentium" >1. Se Old Style: Gentium</a>
          <a class="font-name" data-classname="GoudyStM" >1. Se Old Style: Sorts Mill Goudy</a>
          <a class="font-name" data-classname="LibreBaskerville" >4. Se Transitional: Libre Bask. (Mrs Eaves)</a>
          <a class="font-name" data-classname="LibreCaslon" >4. Se Transitional: Libre Caslon</a>
          <a class="font-name" data-classname="PT" >4. Se Transitional: PT fonts (Le Monde)</a>
          <a class="font-name" data-classname="SourcePro" >4. Se Transitional: Source Pro (Skolar, Fournier)</a>
          <a class="font-name" data-classname="TimesNewRoman" >4. Se Transitional: Times New Roman</a>
          <a class="font-name" data-classname="CM" >5. Se Didone: Computer Modern</a>
          <a class="font-name" data-classname="OldStandardTT" >5. Se Didone: Old Standard TT (Filosofia, Scotch Modern)</a>
          <a class="font-name" data-classname="STIX2" >5. Se Didone: Stix2</a>
          <a class="font-name" data-classname="Charter" >6. Se Scotch: Charter</a>
          <a class="font-name" data-classname="Georgia" >6. Se Scotch: Georgia</a>
          <a class="font-name" data-classname="WorkSans" >8. Sa Grotesque: Work Sans (All Grotesque, FF Bau, Venus)</a>
          <a class="font-name" data-classname="AntiqueOlive" >9. Sa Geometric: Antique Oliv</a>
          <a class="font-name" data-classname="bahnschrift" >9. Sa Geometric: Bahnschrift</a>
          <a class="font-name" data-classname="CooperHewitt" >9. Sa Geometric: Cooper Hewitt (Calibre)</a>
          <a class="font-name" data-classname="SourceSans" >9. Sa Humanist: Source Sans (Balto, Adelle Sans)</a>
          <a class="font-name" data-classname="URWClassico" >9. Sa Humanist: URW Classico (Optima)</a>
          <a class="font-name" data-classname="FiraSans" >a. Sa Humanist: Fira Sans (FF Meta)</a>
          <a class="font-name" data-classname="Nimbus" >a. Sa Humanist: Nimbus (Helvetica)</a>
          <a class="font-name" data-classname="Roboto" >a. Sa Humanist: Roboto (DIN</a>
          <a class="font-name" data-classname="Munson" >b. Sl Grotesque: Munson (Clarendon)</a>
          <a class="font-name" data-classname="Sanchez" >c. Sl Geometric: Sanchez (Rockwell)</a>
          <a class="font-name" data-classname="Enriqueta" >d. Sl Humanist: Enriqueta (PMN Caecilia)</a>
          <a class="font-name" data-classname="Merriweather" >d. Sl Humanist: Merriweather (Chapparal)</a>
          <a class="font-name" data-classname="profont" >Z. Sa Monospace: Profont</a>
</div>
                <a id="to_nav">Menu</a>
                <nav id="primary_nav">
                    

  <a href="../../MyBlog/">home</a>
  <a href="../../MyBlog/tags/">tags</a>
  <a href="https://www.github.com/lucabol">github</a>
  <a href="https://www.linkedin.com/in/lucabolognese/">linkdin</a>
  <a href="../../MyBlog/search">search</a>
  <a href="../../MyBlog/index.xml">rss</a>
                </nav>
            </span>
        </div>
    <h1 id="title">
    
        Simulating INumeric with dynamic in C# 4.0
    
    </h1>

    </header>

    <main>
        

<p>When I wrote my <a href="http://blogs.msdn.com/lucabol/archive/2008/12/04/financial-functions-for-net-released.aspx">Excel financial library</a> I agonized over the decision of which numeric type to use to represent money. Logic would push me toward <em>decimal</em>, but common usage among financial library writers would push me toward <em>double</em>. I ended up picking double, but I regret having to make that choice in the first place.</p>
<p>Conceptually, I&rsquo;d like my numeric functions to work for anything that supports the basic arithmetic operators (i.e. +, -, *). Unfortunately that is not possible in .NET at this point in time. In essence you have to write your code twice as below.</p>
<pre class="code"><span style="background:white;">   </span><span style="background:white;color:blue;">static double </span><span style="background:white;">SumDouble(</span><span style="background:white;color:blue;">double </span><span style="background:white;">a, </span><span style="background:white;color:blue;">double </span><span style="background:white;">b) { </span><span style="background:white;color:blue;">return </span><span style="background:white;">a + b; }
   </span><span style="background:white;color:blue;">static decimal </span><span style="background:white;">SumDecimal(</span><span style="background:white;color:blue;">decimal </span><span style="background:white;">a, </span><span style="background:white;color:blue;">decimal </span><span style="background:white;">b) {</span><span style="background:white;color:blue;">return </span><span style="background:white;">a + b;}</span></pre>
<p>Granted, this is not a good state of affairs. We often discussed how to make it work, but we couldn&rsquo;t find a solution that was both fast to run and cheap for us to implement. More often than not we speculated about having the numeric types implement a specific <em>INumeric</em> interface and add a generic constraint to the C#/VB languages to make it work. Hence the title of this post.</p>
<p>With we implemented <em>dynamic</em> in C# 4.0 it occurred to me that you can fake your way into writing your code just once. For sure, this solution doesn&rsquo;t have the same performance characteristics of ‚Äòwriting your code twice&rsquo;, but at least it doesn&rsquo;t duplicate your code.</p>
<p>This is how it looks like:</p>
<pre class="code"><span style="background:white;">    </span><span style="background:white;color:blue;">static dynamic </span><span style="background:white;">Sum1(</span><span style="background:white;color:blue;">dynamic </span><span style="background:white;">a, </span><span style="background:white;color:blue;">dynamic </span><span style="background:white;">b) { </span><span style="background:white;color:blue;">return </span><span style="background:white;">a + b; }</span></pre>
<p>The call to the ‚Äò+&rsquo; operator is resolved at runtime, by the C# binder, hence a performance penalty is incurred. The penalty is less than you might think, given that the <a href="http://www.codeplex.com/dlr">DLR</a> caches things under the cover so that no v-table lookup is performed the second time around. The whole thing is explained in more detail <a href="http://blogs.msdn.com/cburrows/archive/2008/10/27/c-dynamic.aspx">here</a>. But still, it is not as fast as a normal ‚Äò+&rsquo; operator over a primitive type. I&rsquo;ll let you enjoy micro performance testing this one üôÇ</p>
<p>A slight refinement is to make the code generic so that a caller doesn&rsquo;t see a signature with dynamic types as arguments.</p>
<pre class="code"><span style="background:white;">   </span><span style="background:white;color:blue;">static dynamic </span><span style="background:white;">Sum2&lt;T1, T2&gt;(T1 a, T2 b)
   {
       </span><span style="background:white;color:blue;">dynamic </span><span style="background:white;">ad = a;
       </span><span style="background:white;color:blue;">dynamic </span><span style="background:white;">bd = b;
       </span><span style="background:white;color:blue;">return </span><span style="background:white;">ad + bd;
   }</span></pre>
<p>I could make the return type generic as well, but that would force the caller to be explicit about the types, making the calling code much less readable. The other good thing about this signature is that you get a different call site with each combination of type arguments and, since they are separate, the binding caches should stay small. With the former signature there is only one call site and the cache could pile up to the point where the DLR decides to discard it.</p>
<p>Here is how the calling code looks like right now:</p>
<pre class="code"><span style="background:white;">       </span><span style="background:white;color:#2b91af;">Console</span><span style="background:white;">.WriteLine(Sum2(2m, 4m));
       </span><span style="background:white;color:#2b91af;">Console</span><span style="background:white;">.WriteLine(Sum2(2.0, 4.0));
       </span><span style="background:white;color:#2b91af;">Console</span><span style="background:white;">.WriteLine(Sum2(</span><span style="background:white;color:blue;">new </span><span style="background:white;color:#2b91af;">DateTime</span><span style="background:white;">(2000,12,1), </span><span style="background:white;color:blue;">new </span><span style="background:white;color:#2b91af;">TimeSpan</span><span style="background:white;">(24,0,0)));</span></pre>
<p>Yet another way to write this code is as follows:</p>
<pre class="code"><span style="background:white;">   </span><span style="background:white;color:blue;">public static </span><span style="background:white;">T Sum3&lt;T&gt;(T a, T b)
   {
       </span><span style="background:white;color:blue;">dynamic </span><span style="background:white;">ad = a;
       </span><span style="background:white;color:blue;">dynamic </span><span style="background:white;">bd = b;
       </span><span style="background:white;color:blue;">return </span><span style="background:white;">ad + bd;
   }</span></pre>
<p>This gets around the problem of showing a dynamic return value and give you some more compile time type checking. But it prevents summing not coercible types. The compiler doesn&rsquo;t let you get there. The last line below wont&rsquo; compile:</p>
<pre class="code"><span style="background:white;">       </span><span style="background:white;color:#2b91af;">Console</span><span style="background:white;">.WriteLine(Sum3(2m, 4m));
       </span><span style="background:white;color:#2b91af;">Console</span><span style="background:white;">.WriteLine(Sum3(2.0, 4.0));
       </span><span style="background:white;color:green;">//Console.WriteLine(Sum3(new DateTime(2000,12,1), new TimeSpan(24,0,0)));</span></pre>
<p>Also notice that in VB you could have done this a long time ago üôÇ</p>
<pre class="code"><span style="background:white;">   </span><span style="background:white;color:blue;">Function </span><span style="background:white;">Sum(Of T1, T2)(</span><span style="background:white;color:blue;">ByVal </span><span style="background:white;">a </span><span style="background:white;color:blue;">As </span><span style="background:white;color:#2b91af;">T1</span><span style="background:white;">, </span><span style="background:white;color:blue;">ByVal </span><span style="background:white;">b </span><span style="background:white;color:blue;">As </span><span style="background:white;color:#2b91af;">T2</span><span style="background:white;">)
       </span><span style="background:white;color:blue;">Dim </span><span style="background:white;">aa </span><span style="background:white;color:blue;">As Object </span><span style="background:white;">= a
       </span><span style="background:white;color:blue;">Dim </span><span style="background:white;">bb </span><span style="background:white;color:blue;">As Object </span><span style="background:white;">= b
       </span><span style="background:white;color:blue;">Return </span><span style="background:white;">aa + bb
   </span><span style="background:white;color:blue;">End Function</span></pre>
<p>In summary, by using dynamic you can write your numeric code just once, but you pay a performance price. You are the only one who can decide if the price is worth paying in your particular application. As often, the profiler is your friend.</p>



  
  <div id="disqus-container">
  
    <button id="disqus-button" onclick="showComments()">Show comments</button>
    <div id="disqus-comments">
      
      
      
        <div id="disqus_thread">
        </div>
        <script type="application/javascript">
          function showComments() {
            var disqus_config = function () {
};
// Build and append comments 
var d = document;
var s = d.createElement('script');
s.async = true;
s.src = '//' + "lucabol" + '.disqus.com/embed.js';
s.setAttribute('data-timestamp', + new Date());
(d.head || d.body).appendChild(s);
            // Remove button
var disqusButton = document.getElementById('disqus-button');
disqusButton.parentNode.removeChild(disqusButton); 
// Un-hide comments
var disqusComments = document.getElementById('disqus-comments');
disqusComments.style.display = 'block'; 
          }
        </script>
      
      <noscript>Enable JavaScript to view Disqus comments.</noscript>
    </div>
  
</div>




    </main>

    <aside id="sidebar-left">
        
<div id="tags">
  <header>
    <h1>Tags</h1>
      
    <h2>¬∂</h2>
    
  </header>
  
    
    <nav>
      <ul>
        
            <li><a href="../../MyBlog/tags/csharp">csharp</a></li>
        
      </ul>
    </nav>
    
  
</div>

    </aside>

    <aside id="sidebar-right">
        <section id="TOC">
        
  
    <header>
        <h1>Table of contents</h1>
        <h2>¬∂</h2>
    </header>
    


        </section>
    </aside>

    <a id="to_top" href="#top">Top</a>
    <footer>
        
    </footer>

    <script>
    const th = document.querySelector("#theme")
    th.addEventListener("click", e => {
        const x = document.querySelector(".dropdown-content")
        if (x.style.display === "block") {
            x.removeAttribute("style")
        } else {
            x.style.display = "block";
        }
    })
    const children = document.querySelectorAll(".font-name")
    const allStyles = Array.from(children).map(c => c.dataset.classname)

    const defaultStyle = "TimesNewRoman"
    const retrievedStyle = localStorage.getItem("Style")
    const style = allStyles.includes(retrievedStyle) ? retrievedStyle : defaultStyle
    document.body.className = style;

    const fontEl = document.querySelector(".dropdown-content")
    fontEl.addEventListener("click", e => {
        const el = e.target
        const style = el.dataset.classname
        document.body.className = style;
        localStorage.setItem("Style", style)
    })



</script>
    <script>
const init = () => {

    
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    
    window.ga = window.ga || ((...args) => (ga.q = ga.q || []).push(args));

    ga('create', 'UA-133194891-1', 'auto');
    ga('set', 'transport', 'beacon');
    ga('send', 'pageview');
};


window.addEventListener('load', init);
</script>
    <script>
    if("serviceWorker" in navigator){
        navigator.serviceWorker.register("/sw.js");
    }
</script>
    <script>
    window.addEventListener('offline', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.add("show")
        window.caches.keys().then(strikeNonCached)
    })
    window.addEventListener('online', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.remove("show")

        const as = document.querySelectorAll('main a')
        for(const a of as)
            a.classList.remove('strike')
    })

    const strikeNonCached = cacheKeys => {
        caches.open(cacheKeys[0]).then(cache =>
            cache.keys().then(keys => {
                const as = document.querySelectorAll('main a')
                const urls = keys.map(k => k.url)
                for(const a of as)
                    if(urls.indexOf(a.href) === -1)    
                        a.classList.add('strike')
    }))}

    if(navigator.onLine)
        window.dispatchEvent(new Event('online'))
    else
        window.dispatchEvent(new Event('offline'))

</script>
    <script>
function variableResize() {

  
  let bodyStyles = window.getComputedStyle(document.body);	
	
  let root = document.documentElement;
	
	
	const maxWindowSize = bodyStyles.getPropertyValue('--bp-xlarge') * 16;
	const minWindowSize = bodyStyles.getPropertyValue('--bp-small') * 16;
	
	
	const windowWidth = window.innerWidth
	
  
  const pWidthVar = '--p-wdth';
	const pMinFontWidth = bodyStyles.getPropertyValue('--p-wdth-min');
	const pMaxFontWidth = bodyStyles.getPropertyValue('--p-wdth-max');
	scale(pWidthVar, pMinFontWidth, pMaxFontWidth);

  const pWeightVar = '--p-wght';
	const pMinFontWeight = bodyStyles.getPropertyValue('--p-wght-min');
	const pMaxFontWeight = bodyStyles.getPropertyValue('--p-wght-max');
	scale(pWeightVar, pMinFontWeight, pMaxFontWeight);
	
  const h1WidthVar = '--h1-wdth';
	const h1MinFontWidth = bodyStyles.getPropertyValue('--h1-wdth-min');
	const h1MaxFontWidth = bodyStyles.getPropertyValue('--h1-wdth-max');
	scale(h1WidthVar, h1MinFontWidth, h1MaxFontWidth);

  const h1WeightVar = '--h1-wght';
	const h1MinFontWeight = bodyStyles.getPropertyValue('--h1-wght-min');
	const h1MaxFontWeight = bodyStyles.getPropertyValue('--h1-wght-max');
	scale(h1WeightVar, h1MinFontWeight, h1MaxFontWeight);
	
  const h2WidthVar = '--h2-wdth';
	const h2MinFontWidth = bodyStyles.getPropertyValue('--h2-wdth-min');
	const h2MaxFontWidth = bodyStyles.getPropertyValue('--h2-wdth-max');
	scale(h2WidthVar, h2MinFontWidth, h2MaxFontWidth);

  const h2WeightVar = '--h2-wght';
	const h2MinFontWeight = bodyStyles.getPropertyValue('--h2-wght-min');
	const h2MaxFontWeight = bodyStyles.getPropertyValue('--h2-wght-max');
	scale(h2WeightVar, h2MinFontWeight, h2MaxFontWeight);
	
	function scale(varName, minValue, maxValue) {
		
		minValue = minValue * 1;
		maxValue = maxValue * 1;

		
		const percent = (windowWidth - minWindowSize) / (maxWindowSize - minWindowSize);
		if (maxValue < minValue) {
			var valueScale = minValue - (percent * (minValue - maxValue));
		} else {
			var valueScale = (percent * (maxValue - minValue)) + minValue;
		}
	  
		
		const newValue = windowWidth > maxWindowSize
		   ? maxValue 
		   : windowWidth < minWindowSize 
				? minValue 
				: valueScale;
	   
		
		root.style.setProperty(varName, newValue);
	}
}

window.addEventListener("load", variableResize);
window.addEventListener("resize", variableResize);

</script>
    <script>
  const el = document.querySelector("#to_nav")
  el.addEventListener("click", e => {
    const x = document.querySelector("#primary_nav")
    if (x.style.display === "block") {
      x.removeAttribute("style")
    } else {
      x.style.display = "block";
    }
  })
  window.addEventListener('click', e => {
    const x = document.querySelector("#primary_nav")
    const y = document.querySelector("#to_nav")
    if (!y.contains(e.target) && x.style.display === "block") {
      x.removeAttribute("style")
    } 

    const th = document.querySelector("#theme")
    const x1 = document.querySelector(".dropdown-content")

    if (!th.contains(e.target) && ! x1.contains(e.target) && x1.style.display === "block") {
      x1.removeAttribute("style")
    } 
  })
</script>

</body>
</html>