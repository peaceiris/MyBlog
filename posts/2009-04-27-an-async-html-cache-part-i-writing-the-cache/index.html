<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff"/>


<meta name="description" content="Other posts:
 Part II - Testing the cache  In the process of converting a financial VBA Excel Addin to .NET (more on that in later posts), I found myself in dire need of a HTML cache that can be called from multiple threads without blocking them. Visualize it as a glorified dictionary where each entry is (url, cachedHtml). The only difference is that when you get the page, you pass a callback to be invoked when the html has been loaded (which could be immediately if the html had already been retrieved by someone else).">





<link rel="preload" href="../../fonts/SourceSerifVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../fonts/SourceSansVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<link rel="stylesheet" href="../../css/base.css"> 
<link rel="stylesheet" href="../../css/fonts.css">


  <link rel="preload" href="../../fonts/SourceCodeVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceCodeVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceSerifVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">



  <title>An Async Html cache – Part I - Writing the cache | Lucabol blog</title>


<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../site.webmanifest">
    </head>
<body>
    <header>
        <div id="topnav">
            <a id="logo" href="../../">❧</a>
            
                <time id="blog_date" > 2009/04/04</time>
            
            <span class="offline">~~ Offline ~~</span>
            <span class="rightnav">
                <a id="theme">theme</a><div class="dropdown-content">
          <a class="font-name" data-classname="OpenDyslexic" >0. OpenDyslexic</a>
          <a class="font-name" data-classname="Cardo" >1. Se Old Style: Cardo (Minion, Gallard, Centaur)</a>
          <a class="font-name" data-classname="CrimsonPro" >1. Se Old Style: Crimson Pro (Century, Palatino, Plantin, Sabon)</a>
          <a class="font-name" data-classname="EBGaramond" >1. Se Old Style: Garamond</a>
          <a class="font-name" data-classname="Gentium" >1. Se Old Style: Gentium</a>
          <a class="font-name" data-classname="GoudyStM" >1. Se Old Style: Sorts Mill Goudy</a>
          <a class="font-name" data-classname="LibreBaskerville" >4. Se Transitional: Libre Bask. (Mrs Eaves)</a>
          <a class="font-name" data-classname="LibreCaslon" >4. Se Transitional: Libre Caslon</a>
          <a class="font-name" data-classname="PT" >4. Se Transitional: PT fonts (Le Monde)</a>
          <a class="font-name" data-classname="SourcePro" >4. Se Transitional: Source Pro (Skolar, Fournier)</a>
          <a class="font-name" data-classname="TimesNewRoman" >4. Se Transitional: Times New Roman</a>
          <a class="font-name" data-classname="CM" >5. Se Didone: Computer Modern</a>
          <a class="font-name" data-classname="OldStandardTT" >5. Se Didone: Old Standard TT (Filosofia, Scotch Modern)</a>
          <a class="font-name" data-classname="STIX2" >5. Se Didone: Stix2</a>
          <a class="font-name" data-classname="Charter" >6. Se Scotch: Charter</a>
          <a class="font-name" data-classname="Georgia" >6. Se Scotch: Georgia</a>
          <a class="font-name" data-classname="WorkSans" >8. Sa Grotesque: Work Sans (All Grotesque, FF Bau, Venus)</a>
          <a class="font-name" data-classname="AntiqueOlive" >9. Sa Geometric: Antique Oliv</a>
          <a class="font-name" data-classname="bahnschrift" >9. Sa Geometric: Bahnschrift</a>
          <a class="font-name" data-classname="CooperHewitt" >9. Sa Geometric: Cooper Hewitt (Calibre)</a>
          <a class="font-name" data-classname="SourceSans" >9. Sa Humanist: Source Sans (Balto, Adelle Sans)</a>
          <a class="font-name" data-classname="URWClassico" >9. Sa Humanist: URW Classico (Optima)</a>
          <a class="font-name" data-classname="FiraSans" >a. Sa Humanist: Fira Sans (FF Meta)</a>
          <a class="font-name" data-classname="Nimbus" >a. Sa Humanist: Nimbus (Helvetica)</a>
          <a class="font-name" data-classname="Roboto" >a. Sa Humanist: Roboto (DIN</a>
          <a class="font-name" data-classname="Munson" >b. Sl Grotesque: Munson (Clarendon)</a>
          <a class="font-name" data-classname="Sanchez" >c. Sl Geometric: Sanchez (Rockwell)</a>
          <a class="font-name" data-classname="Enriqueta" >d. Sl Humanist: Enriqueta (PMN Caecilia)</a>
          <a class="font-name" data-classname="Merriweather" >d. Sl Humanist: Merriweather (Chapparal)</a>
          <a class="font-name" data-classname="profont" >Z. Sa Monospace: Profont</a>
</div>
                <a id="to_nav">Menu</a>
                <nav id="primary_nav">
                    

  <a href="../../MyBlog/">home</a>
  <a href="../../MyBlog/tags/">tags</a>
  <a href="https://www.github.com/lucabol">github</a>
  <a href="https://www.linkedin.com/in/lucabolognese/">linkdin</a>
  <a href="../../MyBlog/search">search</a>
  <a href="../../MyBlog/index.xml">rss</a>
                </nav>
            </span>
        </div>
    <h1 id="title">
    
        An Async Html cache – Part I - Writing the cache
    
    </h1>

    </header>

    <main>
        

<p>Other posts:</p>
<ul>
<li><strong><font color="#006bad"><a href="http://blogs.msdn.com/lucabol/">Part II  - Testing the cache</a></font></strong></li>
</ul>
<p>In the process of converting a financial VBA Excel Addin to .NET (more on that in later posts), I found myself in dire need of a HTML cache that can be called from multiple threads without blocking them. Visualize it as a glorified dictionary where each entry is (url, cachedHtml). The only difference is that when you get the page, you pass a callback to be invoked when the html has been loaded (which could be immediately if the html had already been retrieved by someone else).</p>
<p>In essence, I want this:</p>
<pre class="code"><span style="background:white;">    </span><span style="background:white;color:blue;">Public Sub </span><span style="background:white;">GetHtmlAsync(</span><span style="background:white;color:blue;">ByVal </span><span style="background:white;">url </span><span style="background:white;color:blue;">As String</span><span style="background:white;">, </span><span style="background:white;color:blue;">ByVal </span><span style="background:white;">callback </span><span style="background:white;color:blue;">As </span><span style="background:white;color:#2b91af;">Action</span><span style="background:white;">(</span><span style="background:white;color:blue;">Of String</span><span style="background:white;">))</span></pre>
<p>I’m not a big expert in the <a href="http://msdn.microsoft.com/en-us/concurrency/default.aspx">.Net Parallel Extensions</a>, but I’ve got <a href="http://blogs.msdn.com/pfxteam">help</a>. Stephen Toub helped so much with this that he could have blogged about it himself. And, by the way, this code runs on Visual Studio 2010, which we haven’t shipped yet. I believe with some modifications, it can be run in 2008 + .Net Parallel Extensions CTP, but you’ll have to change a bunch of names.</p>
<p>In any case, here it comes. First, let’s add some imports.</p>
<pre class="code"><span style="background:white;">Imports </span><span style="background:white;color:black;">System.Collections.Concurrent
</span><span style="background:white;">Imports </span><span style="background:white;color:black;">System.Threading.Tasks
</span><span style="background:white;">Imports </span><span style="background:white;color:black;">System.Threading
</span><span style="background:white;">Imports </span><span style="background:white;color:black;">System.</span><span style="background:white;color:#0000a5;">Net</span></pre>
<p>Then, let’s define an asynchronous cache.</p>
<pre class="code"><span style="background:white;">Public Class </span><span style="background:white;color:#2b91af;">AsyncCache</span><span style="background:white;color:black;">(</span><span style="background:white;">Of </span><span style="background:white;color:black;">TKey, </span><span style="background:white;color:#0000a5;">TValue</span><span style="background:white;color:black;">)</span></pre>
<p>This thing needs to store the (url, html) pairs somewhere and, luckily enough, there is an handy <em>ConcurrentDictionary</em> that I can use. Also the cache needs to know how to load a <em>TValue</em> given a <em>TKey</em>. In ‘programmingese’, that means.</p>
<pre class="code"><span style="background:white;">    </span><span style="background:white;color:blue;">Private </span><span style="background:white;">_loader </span><span style="background:white;color:blue;">As </span><span style="background:white;color:#2b91af;">Func</span><span style="background:white;">(</span><span style="background:white;color:blue;">Of </span><span style="background:white;color:#2b91af;">TKey</span><span style="background:white;">, </span><span style="background:white;color:#2b91af;">TValue</span><span style="background:white;">)
    </span><span style="background:white;color:blue;">Private </span><span style="background:white;">_map </span><span style="background:white;color:blue;">As New </span><span style="background:white;color:#2b91af;">ConcurrentDictionary</span><span style="background:white;">(</span><span style="background:white;color:blue;">Of </span><span style="background:white;color:#2b91af;">TKey</span><span style="background:white;">, </span><span style="background:white;color:#2b91af;">Task</span><span style="background:white;">(</span><span style="background:white;color:blue;">Of </span><span style="background:white;color:#2b91af;">TValue</span><span style="background:white;">))</span></pre>
<p>I’ll need a way to create it.</p>
<pre class="code"><span style="background:white;">    </span><span style="background:white;color:blue;">Public Sub New</span><span style="background:white;">(</span><span style="background:white;color:blue;">ByVal </span><span style="background:white;">l </span><span style="background:white;color:blue;">As </span><span style="background:white;color:#2b91af;">Func</span><span style="background:white;">(</span><span style="background:white;color:blue;">Of </span><span style="background:white;color:#2b91af;">TKey</span><span style="background:white;">, </span><span style="background:white;color:#2b91af;">TValue</span><span style="background:white;">))
        _loader = l
    </span><span style="background:white;color:blue;">End Sub</span></pre>
<p>Notice in the above code the use of the <em>Task</em> class for my dictionary instead of <em>TValue</em>. Task is a very good abstraction for “do some work asynchronously and call me when you are done”. It’s easy to initialize and it’s easy to attach callbacks to it. Indeed, this is what we’ll do next:</p>
<pre class="code"><span style="background:white;">    </span><span style="background:white;color:blue;">Public Sub </span><span style="background:white;">GetValueAsync(</span><span style="background:white;color:blue;">ByVal </span><span style="background:white;">key </span><span style="background:white;color:blue;">As </span><span style="background:white;color:#2b91af;">TKey</span><span style="background:white;">, </span><span style="background:white;color:blue;">ByVal </span><span style="background:white;">callback </span><span style="background:white;color:blue;">As </span><span style="background:white;color:#2b91af;">Action</span><span style="background:white;">(</span><span style="background:white;color:blue;">Of </span><span style="background:white;color:#2b91af;">TValue</span><span style="background:white;">))
        </span><span style="background:white;color:blue;">Dim </span><span style="background:white;">task </span><span style="background:white;color:blue;">As </span><span style="background:white;color:#2b91af;">Task</span><span style="background:white;">(</span><span style="background:white;color:blue;">Of </span><span style="background:white;color:#2b91af;">TValue</span><span style="background:white;">) = </span><span style="background:white;color:blue;">Nothing
        If Not </span><span style="background:white;">_map.TryGetValue(key, task) </span><span style="background:white;color:blue;">Then
            </span><span style="background:white;">task = </span><span style="background:white;color:blue;">New </span><span style="background:white;color:#2b91af;">Task</span><span style="background:white;">(</span><span style="background:white;color:blue;">Of </span><span style="background:white;color:#2b91af;">TValue</span><span style="background:white;">)(</span><span style="background:white;color:blue;">Function</span><span style="background:white;">() _loader(key), </span><span style="background:white;color:#2b91af;">TaskCreationOptions</span><span style="background:white;">.DetachedFromParent)
            </span><span style="background:white;color:blue;">If </span><span style="background:white;">_map.TryAdd(key, task) </span><span style="background:white;color:blue;">Then
                </span><span style="background:white;color:#2b91af;">task</span><span style="background:white;">.Start()
            </span><span style="background:white;color:blue;">Else
                </span><span style="background:white;color:#2b91af;">task</span><span style="background:white;">.Cancel()
                _map.TryGetValue(key, task)
            </span><span style="background:white;color:blue;">End If
        End If
        </span><span style="background:white;color:#2b91af;">task</span><span style="background:white;">.ContinueWith(</span><span style="background:white;color:blue;">Sub</span><span style="background:white;">(t) callback(t.Result))
    </span><span style="background:white;color:blue;">End Sub</span></pre>
<p>Wow. Ok, let me explain. This method is divided in two parts. The first part is just a thread safe way to say “give me the task corresponding to this key or, if the task hasn’t been inserted in the cache yet, create it and insert it”. The second part just says “add callback to the list of functions to be called when the task has finished running”.</p>
<p>The first part needs some more explanation. What is <span style="background:white;color:#2b91af;">TaskCreationOptions</span><span style="background:white;">.DetachedFromParent? It essentially says that the created task is not going to prevent the parent task from terminating. In essence, the task that created the child task won’t wait for its conclusion. The rest is better explained in comments.</span></p>
<pre class="code"><span style="background:white;">        </span><span style="background:white;color:blue;">If Not </span><span style="background:white;">_map.TryGetValue(key, task) </span><span style="background:white;color:blue;">Then </span><span style="background:white;color:green;">' Is the task in the cache? (Loc. X)
            </span><span style="background:white;">task = </span><span style="background:white;color:blue;">New </span><span style="background:white;color:#2b91af;">Task</span><span style="background:white;">(</span><span style="background:white;color:blue;">Of </span><span style="background:white;color:#2b91af;">TValue</span><span style="background:white;">)(</span><span style="background:white;color:blue;">Function</span><span style="background:white;">() _loader(key), </span><span style="background:white;color:#2b91af;">TaskCreationOptions</span><span style="background:white;">.DetachedFromParent) </span><span style="background:white;color:green;">' No, create it
            </span><span style="background:white;color:blue;">If </span><span style="background:white;">_map.TryAdd(key, task) </span><span style="background:white;color:blue;">Then </span><span style="background:white;color:green;">' Try to add it
                </span><span style="background:white;color:#2b91af;">task</span><span style="background:white;">.Start() </span><span style="background:white;color:green;">' I succeeded. I’m the one who added this task. I can safely start it.
            </span><span style="background:white;color:blue;">Else
                </span><span style="background:white;color:#2b91af;">task</span><span style="background:white;">.Cancel() </span><span style="background:white;color:green;">' I failed, someone inserted the task after I checked in (Loc. X). Cancel it.
                </span><span style="background:white;">_map.TryGetValue(key, task) </span><span style="background:white;color:green;">' And get the one that someone inserted
            </span><span style="background:white;color:blue;">End If
        End If</span></pre>
<p>Got it? Well, I admit I trust Stephen that this is what I should do …</p>
<p>I can then create my little HTML Cache by using the above class as in:</p>
<pre class="code"><span style="background:white;">Public Class </span><span style="background:white;color:#2b91af;">HtmlCache
</span><span style="background:white;">
    Public Sub </span><span style="background:white;color:black;">GetHtmlAsync(</span><span style="background:white;">ByVal </span><span style="background:white;color:black;">url </span><span style="background:white;">As String</span><span style="background:white;color:black;">, </span><span style="background:white;">ByVal </span><span style="background:white;color:black;">callback </span><span style="background:white;">As </span><span style="background:white;color:#2b91af;">Action</span><span style="background:white;color:black;">(</span><span style="background:white;">Of String</span><span style="background:white;color:black;">))
        _asyncCache.GetValueAsync(url, callback)
    </span><span style="background:white;">End Sub
    Private Function </span><span style="background:white;color:black;">LoadWebPage(</span><span style="background:white;">ByVal </span><span style="background:white;color:black;">url </span><span style="background:white;">As String</span><span style="background:white;color:black;">) </span><span style="background:white;">As String
        Using </span><span style="background:white;color:black;">client </span><span style="background:white;">As New </span><span style="background:white;color:#2b91af;">WebClient</span><span style="background:white;color:black;">()
            </span><span style="background:white;color:green;">'Test.PrintThread("Downloading on thread {0} ...")
            </span><span style="background:white;">Return </span><span style="background:white;color:black;">client.DownloadString(url)
        </span><span style="background:white;">End Using
    End Function
    Private </span><span style="background:white;color:black;">_asyncCache </span><span style="background:white;">As New </span><span style="background:white;color:#2b91af;">AsyncCache</span><span style="background:white;color:black;">(</span><span style="background:white;">Of String</span><span style="background:white;color:black;">, </span><span style="background:white;">String</span><span style="background:white;color:black;">)(</span><span style="background:white;">AddressOf </span><span style="background:white;color:black;">LoadWebPage)
</span><span style="background:white;">End Class</span></pre>
<p>I have no idea why coloring got disabled when I copy/paste. It doesn’t matter, this is trivial. I just create an <em>AsyncCache</em> and initialize it with a method that knows how to load a web page. I then simply implement <em>GetHtmlAsync</em> by delegating to the underlying <em>GetValueAsync</em> on <em>AsyncCache</em>.</p>
<p>It is somehow bizarre to call <em>Webclient.DownloadString</em>, when the design could be revised to take advantage of its asynchronous version. Maybe I’ll do it in another post. Next time, I’ll write code to use this thing.</p>



  
  <div id="disqus-container">
  
    <button id="disqus-button" onclick="showComments()">Show comments</button>
    <div id="disqus-comments">
      
      
      
        <div id="disqus_thread">
        </div>
        <script type="application/javascript">
          function showComments() {
            var disqus_config = function () {
};
// Build and append comments 
var d = document;
var s = d.createElement('script');
s.async = true;
s.src = '//' + "lucabol" + '.disqus.com/embed.js';
s.setAttribute('data-timestamp', + new Date());
(d.head || d.body).appendChild(s);
            // Remove button
var disqusButton = document.getElementById('disqus-button');
disqusButton.parentNode.removeChild(disqusButton); 
// Un-hide comments
var disqusComments = document.getElementById('disqus-comments');
disqusComments.style.display = 'block'; 
          }
        </script>
      
      <noscript>Enable JavaScript to view Disqus comments.</noscript>
    </div>
  
</div>




    </main>

    <aside id="sidebar-left">
        
<div id="tags">
  <header>
    <h1>Tags</h1>
      
    <h2>¶</h2>
    
  </header>
  
    
    <nav>
      <ul>
        
            <li><a href="../../MyBlog/tags/vb">VB</a></li>
        
      </ul>
    </nav>
    
  
</div>

    </aside>

    <aside id="sidebar-right">
        <section id="TOC">
        
  
    <header>
        <h1>Table of contents</h1>
        <h2>¶</h2>
    </header>
    


        </section>
    </aside>

    <a id="to_top" href="#top">Top</a>
    <footer>
        
    </footer>

    <script>
    const th = document.querySelector("#theme")
    th.addEventListener("click", e => {
        const x = document.querySelector(".dropdown-content")
        if (x.style.display === "block") {
            x.removeAttribute("style")
        } else {
            x.style.display = "block";
        }
    })
    const children = document.querySelectorAll(".font-name")
    const allStyles = Array.from(children).map(c => c.dataset.classname)

    const defaultStyle = "TimesNewRoman"
    const retrievedStyle = localStorage.getItem("Style")
    const style = allStyles.includes(retrievedStyle) ? retrievedStyle : defaultStyle
    document.body.className = style;

    const fontEl = document.querySelector(".dropdown-content")
    fontEl.addEventListener("click", e => {
        const el = e.target
        const style = el.dataset.classname
        document.body.className = style;
        localStorage.setItem("Style", style)
    })



</script>
    <script>
const init = () => {

    
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    
    window.ga = window.ga || ((...args) => (ga.q = ga.q || []).push(args));

    ga('create', 'UA-133194891-1', 'auto');
    ga('set', 'transport', 'beacon');
    ga('send', 'pageview');
};


window.addEventListener('load', init);
</script>
    <script>
    if("serviceWorker" in navigator){
        navigator.serviceWorker.register("/sw.js");
    }
</script>
    <script>
    window.addEventListener('offline', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.add("show")
        window.caches.keys().then(strikeNonCached)
    })
    window.addEventListener('online', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.remove("show")

        const as = document.querySelectorAll('main a')
        for(const a of as)
            a.classList.remove('strike')
    })

    const strikeNonCached = cacheKeys => {
        caches.open(cacheKeys[0]).then(cache =>
            cache.keys().then(keys => {
                const as = document.querySelectorAll('main a')
                const urls = keys.map(k => k.url)
                for(const a of as)
                    if(urls.indexOf(a.href) === -1)    
                        a.classList.add('strike')
    }))}

    if(navigator.onLine)
        window.dispatchEvent(new Event('online'))
    else
        window.dispatchEvent(new Event('offline'))

</script>
    <script>
function variableResize() {

  
  let bodyStyles = window.getComputedStyle(document.body);	
	
  let root = document.documentElement;
	
	
	const maxWindowSize = bodyStyles.getPropertyValue('--bp-xlarge') * 16;
	const minWindowSize = bodyStyles.getPropertyValue('--bp-small') * 16;
	
	
	const windowWidth = window.innerWidth
	
  
  const pWidthVar = '--p-wdth';
	const pMinFontWidth = bodyStyles.getPropertyValue('--p-wdth-min');
	const pMaxFontWidth = bodyStyles.getPropertyValue('--p-wdth-max');
	scale(pWidthVar, pMinFontWidth, pMaxFontWidth);

  const pWeightVar = '--p-wght';
	const pMinFontWeight = bodyStyles.getPropertyValue('--p-wght-min');
	const pMaxFontWeight = bodyStyles.getPropertyValue('--p-wght-max');
	scale(pWeightVar, pMinFontWeight, pMaxFontWeight);
	
  const h1WidthVar = '--h1-wdth';
	const h1MinFontWidth = bodyStyles.getPropertyValue('--h1-wdth-min');
	const h1MaxFontWidth = bodyStyles.getPropertyValue('--h1-wdth-max');
	scale(h1WidthVar, h1MinFontWidth, h1MaxFontWidth);

  const h1WeightVar = '--h1-wght';
	const h1MinFontWeight = bodyStyles.getPropertyValue('--h1-wght-min');
	const h1MaxFontWeight = bodyStyles.getPropertyValue('--h1-wght-max');
	scale(h1WeightVar, h1MinFontWeight, h1MaxFontWeight);
	
  const h2WidthVar = '--h2-wdth';
	const h2MinFontWidth = bodyStyles.getPropertyValue('--h2-wdth-min');
	const h2MaxFontWidth = bodyStyles.getPropertyValue('--h2-wdth-max');
	scale(h2WidthVar, h2MinFontWidth, h2MaxFontWidth);

  const h2WeightVar = '--h2-wght';
	const h2MinFontWeight = bodyStyles.getPropertyValue('--h2-wght-min');
	const h2MaxFontWeight = bodyStyles.getPropertyValue('--h2-wght-max');
	scale(h2WeightVar, h2MinFontWeight, h2MaxFontWeight);
	
	function scale(varName, minValue, maxValue) {
		
		minValue = minValue * 1;
		maxValue = maxValue * 1;

		
		const percent = (windowWidth - minWindowSize) / (maxWindowSize - minWindowSize);
		if (maxValue < minValue) {
			var valueScale = minValue - (percent * (minValue - maxValue));
		} else {
			var valueScale = (percent * (maxValue - minValue)) + minValue;
		}
	  
		
		const newValue = windowWidth > maxWindowSize
		   ? maxValue 
		   : windowWidth < minWindowSize 
				? minValue 
				: valueScale;
	   
		
		root.style.setProperty(varName, newValue);
	}
}

window.addEventListener("load", variableResize);
window.addEventListener("resize", variableResize);

</script>
    <script>
  const el = document.querySelector("#to_nav")
  el.addEventListener("click", e => {
    const x = document.querySelector("#primary_nav")
    if (x.style.display === "block") {
      x.removeAttribute("style")
    } else {
      x.style.display = "block";
    }
  })
  window.addEventListener('click', e => {
    const x = document.querySelector("#primary_nav")
    const y = document.querySelector("#to_nav")
    if (!y.contains(e.target) && x.style.display === "block") {
      x.removeAttribute("style")
    } 

    const th = document.querySelector("#theme")
    const x1 = document.querySelector(".dropdown-content")

    if (!th.contains(e.target) && ! x1.contains(e.target) && x1.style.display === "block") {
      x1.removeAttribute("style")
    } 
  })
</script>

</body>
</html>