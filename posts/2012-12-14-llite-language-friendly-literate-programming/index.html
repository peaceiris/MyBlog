<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ffffff"/>


<meta name="description" content="Main ideas My interest in literate programming comes from some realizations on my part:
 When I go back to code that I have written some time ago, I don&amp;rsquo;t remember my reasoning When I write a blog post, my code seems to be better. Perhaps explaining things to people encourages me to be more precise I like to think top down, but the compiler forces me to write code bottom up, starting from details and going to higher level concepts  Unhappiness with existing tools Many of the existing literate programming tools work similarly to the original CWeb.">





<link rel="preload" href="../../fonts/SourceSerifVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../fonts/SourceSansVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<link rel="stylesheet" href="../../css/base.css"> 
<link rel="stylesheet" href="../../css/fonts.css">


  <link rel="preload" href="../../fonts/SourceCodeVariable-Roman.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceCodeVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="../../fonts/SourceSerifVariable-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">



  <title>LLite : language friendly literate programming | Lucabol blog</title>


<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../site.webmanifest">
    </head>
<body>
    <header>
        <div id="topnav">
            <a id="logo" href="../../">‚ùß</a>
            
                <time id="blog_date" > 2012/12/12</time>
            
            <span class="offline">~~ Offline ~~</span>
            <span class="rightnav">
                <a id="theme">theme</a><div class="dropdown-content">
          <a class="font-name" data-classname="OpenDyslexic" >0. OpenDyslexic</a>
          <a class="font-name" data-classname="Cardo" >1. Se Old Style: Cardo (Minion, Gallard, Centaur)</a>
          <a class="font-name" data-classname="CrimsonPro" >1. Se Old Style: Crimson Pro (Century, Palatino, Plantin, Sabon)</a>
          <a class="font-name" data-classname="EBGaramond" >1. Se Old Style: Garamond</a>
          <a class="font-name" data-classname="Gentium" >1. Se Old Style: Gentium</a>
          <a class="font-name" data-classname="GoudyStM" >1. Se Old Style: Sorts Mill Goudy</a>
          <a class="font-name" data-classname="LibreBaskerville" >4. Se Transitional: Libre Bask. (Mrs Eaves)</a>
          <a class="font-name" data-classname="LibreCaslon" >4. Se Transitional: Libre Caslon</a>
          <a class="font-name" data-classname="PT" >4. Se Transitional: PT fonts (Le Monde)</a>
          <a class="font-name" data-classname="SourcePro" >4. Se Transitional: Source Pro (Skolar, Fournier)</a>
          <a class="font-name" data-classname="TimesNewRoman" >4. Se Transitional: Times New Roman</a>
          <a class="font-name" data-classname="CM" >5. Se Didone: Computer Modern</a>
          <a class="font-name" data-classname="OldStandardTT" >5. Se Didone: Old Standard TT (Filosofia, Scotch Modern)</a>
          <a class="font-name" data-classname="STIX2" >5. Se Didone: Stix2</a>
          <a class="font-name" data-classname="Charter" >6. Se Scotch: Charter</a>
          <a class="font-name" data-classname="Georgia" >6. Se Scotch: Georgia</a>
          <a class="font-name" data-classname="WorkSans" >8. Sa Grotesque: Work Sans (All Grotesque, FF Bau, Venus)</a>
          <a class="font-name" data-classname="AntiqueOlive" >9. Sa Geometric: Antique Oliv</a>
          <a class="font-name" data-classname="bahnschrift" >9. Sa Geometric: Bahnschrift</a>
          <a class="font-name" data-classname="CooperHewitt" >9. Sa Geometric: Cooper Hewitt (Calibre)</a>
          <a class="font-name" data-classname="SourceSans" >9. Sa Humanist: Source Sans (Balto, Adelle Sans)</a>
          <a class="font-name" data-classname="URWClassico" >9. Sa Humanist: URW Classico (Optima)</a>
          <a class="font-name" data-classname="FiraSans" >a. Sa Humanist: Fira Sans (FF Meta)</a>
          <a class="font-name" data-classname="Nimbus" >a. Sa Humanist: Nimbus (Helvetica)</a>
          <a class="font-name" data-classname="Roboto" >a. Sa Humanist: Roboto (DIN</a>
          <a class="font-name" data-classname="Munson" >b. Sl Grotesque: Munson (Clarendon)</a>
          <a class="font-name" data-classname="Sanchez" >c. Sl Geometric: Sanchez (Rockwell)</a>
          <a class="font-name" data-classname="Enriqueta" >d. Sl Humanist: Enriqueta (PMN Caecilia)</a>
          <a class="font-name" data-classname="Merriweather" >d. Sl Humanist: Merriweather (Chapparal)</a>
          <a class="font-name" data-classname="profont" >Z. Sa Monospace: Profont</a>
</div>
                <a id="to_nav">Menu</a>
                <nav id="primary_nav">
                    

  <a href="../../MyBlog/">home</a>
  <a href="../../MyBlog/tags/">tags</a>
  <a href="https://www.github.com/lucabol">github</a>
  <a href="https://www.linkedin.com/in/lucabolognese/">linkdin</a>
  <a href="../../MyBlog/search">search</a>
  <a href="../../MyBlog/index.xml">rss</a>
                </nav>
            </span>
        </div>
    <h1 id="title">
    
        LLite : language friendly literate programming
    
    </h1>

    </header>

    <main>
        

<h1 id="main-ideas">Main ideas</h1>
<p>My interest in <a href="http://en.wikipedia.org/wiki/Literate_programming">literate programming</a>
comes from some realizations on my part:</p>
<ul>
<li>When I go back to code that I have written some time ago, I don&rsquo;t remember my reasoning</li>
<li>When I write a blog post, my code seems to be better. Perhaps explaining things to people encourages
me to be more precise</li>
<li>I like to think top down, but the compiler forces me to write code bottom up, starting from details and
going to higher level concepts</li>
</ul>
<h2 id="unhappiness-with-existing-tools">Unhappiness with existing tools</h2>
<p>Many of the existing literate programming tools work similarly to the original <a href="http://www-cs-faculty.stanford.edu/~uno/cweb.html">CWeb</a>.</p>
<ul>
<li>They have a tangle program that goes over your file and extract something that the compiler can understand</li>
<li>They have a weave program that extracts from your file something that the document generator can understand</li>
</ul>
<p>This scheme has the unfortunate limitation of breaking your code editor. Given
that your file is not a valid code file anymore, the editor starts misbehaving (i.e. intellisense breaks).
The debugger starts to get confused (albeit people tried to remediate that with cleaver use of <code>#line</code>.
If your language has an interactive console, that would not work either.</p>
<h2 id="a-different-interpretation">A different interpretation</h2>
<p>The main idea of this program is to add your narrative to the comment part of a
code file by extending the comment tag (i.e. in C you could use /** ). This keeps editor, debugger and interactive console working.</p>
<p>The weave phase as been retained and what you are reading is the program that goes over your code file and extracts
a nicely formatted (for this program in &lsquo;markdown&rsquo; format) file that can then be translated to HTML, PDF, latex, etc&hellip;</p>
<p>You got that? <em>The document you are reading now <strong>is</strong> the program.</em></p>
<h2 id="multi-language-multi-document-format">Multi-language, multi-document format</h2>
<p>LLite works for any programming language, assuming it has open and close <em>comment</em> character sequences, and any documentation format,
assuming it has open and close <em>code</em> character sequences (aka allows you to delimitate your code somehow), or it needs the code to be indented.
This document uses <a href="http://daringfireball.net/projects/markdown/">markdown</a> (with <a href="http://johnmacfarlane.net/pandoc/">Pandoc</a>
extensions to generate table of contents and titles).</p>
<h2 id="usage">Usage</h2>
<p>You invoke the program as documented below. The first set of parameters lets you choose the symbols that delimitate your language comments (or the default symbols below).
The second set of parameters lets you choose how your target documentation language treats code. Either it delimits it with some symbols or it indents it.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">module</span> <span style="color:#555">LLite</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">langParamsTable</span>     <span style="font-weight:bold">=</span> <span style="font-weight:bold">[</span> <span style="color:#b84">&#34;</span><span style="color:#b84">fsharp</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span> <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">(*</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84">*</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span> <span style="color:#b84">&#34;</span><span style="color:#b84">*</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84">*)</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span> <span style="color:#998;font-style:italic">// The + is not to confuse the parser
</span><span style="color:#998;font-style:italic"></span>                            <span style="color:#b84">&#34;</span><span style="color:#b84">c</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span> <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">/**</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span> <span style="color:#b84">&#34;</span><span style="color:#b84">**/</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>
                            <span style="color:#b84">&#34;</span><span style="color:#b84">csharp</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span> <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">/**</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span> <span style="color:#b84">&#34;</span><span style="color:#b84">**/</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>
                            <span style="color:#b84">&#34;</span><span style="color:#b84">java</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span> <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">/**</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span> <span style="color:#b84">&#34;</span><span style="color:#b84">**/</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span><span style="font-weight:bold">]</span> <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Map</span>.ofList

<span style="font-weight:bold">let</span> <span style="color:#008080">languages</span> <span style="font-weight:bold">=</span> langParamsTable <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Map</span>.fold <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> state lang <span style="font-weight:bold">_</span> <span style="font-weight:bold">-&gt;</span> state <span style="font-weight:bold">+</span> lang <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84"> </span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span> <span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">usage</span>   <span style="font-weight:bold">=</span> sprintf <span style="color:#b84">@&#34;</span><span style="color:#b84">
</span><span style="color:#b84">Usage: llite inputFile parameters
</span><span style="color:#b84">where:
</span><span style="color:#b84">One of the following two sets of parameters is mandatory
</span><span style="color:#b84">    -no string : string opening a narrative comment
</span><span style="color:#b84">    -nc string : string closing a narrative comment
</span><span style="color:#b84">or
</span><span style="color:#b84">    -l language: where language is one of (%s)
</span><span style="color:#b84">
</span><span style="color:#b84">One of the following two sets of parameters is mandatory
</span><span style="color:#b84">    -co string : string opening a code block
</span><span style="color:#b84">    -cc string : string closing a code block
</span><span style="color:#b84">or
</span><span style="color:#b84">    -indent N  : indent the code by N whitespaces
</span><span style="color:#b84">
</span><span style="color:#b84">The following parameters are optional:
</span><span style="color:#b84">    -o outFile : defaults to the input file name with mkd extension</span><span style="color:#b84">&#34;</span> languages


<span style="font-weight:bold">let</span> <span style="color:#008080">getLangNoNC</span> lang    <span style="font-weight:bold">=</span>
    <span style="font-weight:bold">match</span> <span style="color:#555">Map</span>.tryFind lang langParamsTable <span style="font-weight:bold">with</span>
    <span style="font-weight:bold">|</span> Some<span style="font-weight:bold">(</span>no<span style="font-weight:bold">,</span> nc<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> no<span style="font-weight:bold">,</span> nc
    <span style="font-weight:bold">|</span> None <span style="font-weight:bold">-&gt;</span> failwith <span style="font-weight:bold">(</span>lang <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84"> is not a valid programming language</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>
</code></pre></div><h2 id="programming-languages-limitations">Programming Languages limitations</h2>
<p>One of the main tenets of literate programming is that the code should be written in the order that facilitates
exposition to a human reader, not in the order that makes the compiler happy. This is very important.</p>
<p>If you have written a blog post or tried to explain a codebase to a new joiner, you must have noticed
that you don&rsquo;t start from the top of the file and go down, but jump here and there trying to better explain
the main concepts. Literate programming says that you should write your code the same way.
But in our version of it, the compiler needs to be kept happy because the literate file <em>is</em> the code file.</p>
<p>Some ingenuity is required to achieve such goal:</p>
<ul>
<li>In C and C++ you can forward declare functions and classes, also class members can be in any order</li>
<li>In C#, Java, VB.NET, F# (the object oriented part) you can write class members in any order</li>
<li>In the functional part of F# you do have a problem (see <a href="#an-aside-forward-declaring-functions-in-F">later in this doc</a>)</li>
</ul>
<p>The F# trick below is used in the rest of the program. You&rsquo;ll understand its usage naturally by just reading the code</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">declare</span><span style="font-weight:bold">&lt;</span><span style="font-weight:bold">&#39;</span>a<span style="font-weight:bold">&gt;</span>  <span style="font-weight:bold">=</span> ref <span style="color:#555">Unchecked</span>.defaultof<span style="font-weight:bold">&lt;</span><span style="font-weight:bold">&#39;</span>a<span style="font-weight:bold">&gt;</span>
</code></pre></div><h1 id="implementation">Implementation</h1>
<p>At the core, this program is a simple translator that takes some code text and return a valid markdown/whatever text.
We need to know:</p>
<ul>
<li>The strings that start and end a narrative comment (input symbols)</li>
<li>How to translate a code block into a document. We support these variations:
<ul>
<li>Indented: indent them by N spaces</li>
<li>Surrounded by startCode/endCode strings</li>
</ul>
</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">type</span> <span style="color:#458;font-weight:bold">CodeSymbols</span> <span style="font-weight:bold">=</span>
    <span style="font-weight:bold">|</span> Indent <span style="font-weight:bold">of</span> int                 <span style="color:#998;font-style:italic">// indentation level in whitespaces
</span><span style="color:#998;font-style:italic"></span>    <span style="font-weight:bold">|</span> Surrounded <span style="font-weight:bold">of</span> <span style="color:#458;font-weight:bold">string</span> <span style="font-weight:bold">*</span> <span style="color:#458;font-weight:bold">string</span> <span style="color:#998;font-style:italic">// start code * end code
</span><span style="color:#998;font-style:italic"></span>
<span style="font-weight:bold">type</span> <span style="color:#458;font-weight:bold">Options</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">{</span>
    startNarrative  <span style="font-weight:bold">:</span> <span style="color:#458;font-weight:bold">string</span>
    endNarrative    <span style="font-weight:bold">:</span> <span style="color:#458;font-weight:bold">string</span>
    codeSymbols     <span style="font-weight:bold">:</span> CodeSymbols
<span style="font-weight:bold">}</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">translate</span>   <span style="font-weight:bold">=</span> declare<span style="font-weight:bold">&lt;</span>Options <span style="font-weight:bold">-&gt;</span> <span style="color:#458;font-weight:bold">string</span> <span style="font-weight:bold">-&gt;</span> <span style="color:#458;font-weight:bold">string</span><span style="font-weight:bold">&gt;</span>
</code></pre></div><h2 id="going-over-the-parse-tree">Going over the parse tree</h2>
<p>We need a function that takes a string and returns a list with the various blocks. We can then go over each block,
perform some operations and, in the end, transform it back to text</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">type</span> <span style="color:#458;font-weight:bold">Block</span> <span style="font-weight:bold">=</span>
<span style="font-weight:bold">|</span> Code      <span style="font-weight:bold">of</span> <span style="color:#458;font-weight:bold">string</span>
<span style="font-weight:bold">|</span> Narrative <span style="font-weight:bold">of</span> <span style="color:#458;font-weight:bold">string</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">blockize</span> <span style="font-weight:bold">=</span> declare<span style="font-weight:bold">&lt;</span>Options <span style="font-weight:bold">-&gt;</span> <span style="color:#458;font-weight:bold">string</span> <span style="font-weight:bold">-&gt;</span> Block <span style="color:#458;font-weight:bold">list</span><span style="font-weight:bold">&gt;</span>
</code></pre></div><p>I could have used regular expressions to parse the program, but it seemed ugly. I could also have used FsParsec,
but that brings with it an additional dll. So I decided to roll my own parser. This has several problems:</p>
<ul>
<li>It is probably very slow</li>
<li>It doesn&rsquo;t allow narrative comments inside comments, in particular it doesn&rsquo;t allow the opening comment</li>
<li>It doesn&rsquo;t allow opening comments in the program code (not even inside a string)</li>
</ul>
<p>The latter in particular is troublesome. You&rsquo;ll need to use a trick in the code (i.e. concatenating strings)
to foul this program in not seeing an opening comment, but it is inconvenient.</p>
<p>With all of that, it works.</p>
<p>TODO: consider switching to FsParsec</p>
<p>###Lexer</p>
<p>The lexer is going to process list of characters. We need functions to check if a list of characters starts
with certain chars and to return the remaining list after having removed such chars.</p>
<p>BTW: these functions are polymorphic and tail recursive</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">rec</span> startWith startItems listToCheck <span style="font-weight:bold">=</span>
    <span style="font-weight:bold">match</span> startItems<span style="font-weight:bold">,</span> listToCheck <span style="font-weight:bold">with</span>
    <span style="font-weight:bold">|</span> []<span style="font-weight:bold">,</span> <span style="font-weight:bold">_</span>             <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">true</span>
    <span style="font-weight:bold">|</span> <span style="font-weight:bold">_</span> <span style="font-weight:bold">,</span> []            <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">false</span>
    <span style="font-weight:bold">|</span> h1<span style="font-weight:bold">::</span>t1<span style="font-weight:bold">,</span> h2<span style="font-weight:bold">::</span>t2  <span style="font-weight:bold">when</span> h1 <span style="font-weight:bold">=</span> h2  <span style="font-weight:bold">-&gt;</span> startWith t1 t2
    <span style="font-weight:bold">|</span> <span style="font-weight:bold">_</span><span style="font-weight:bold">,</span> <span style="font-weight:bold">_</span>              <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">false</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">rec</span> remove itemsToRemove listToModify <span style="font-weight:bold">=</span>
    <span style="font-weight:bold">match</span> itemsToRemove<span style="font-weight:bold">,</span> listToModify <span style="font-weight:bold">with</span>
    <span style="font-weight:bold">|</span> []<span style="font-weight:bold">,</span> l             <span style="font-weight:bold">-&gt;</span> l
    <span style="font-weight:bold">|</span> <span style="font-weight:bold">_</span> <span style="font-weight:bold">,</span> []            <span style="font-weight:bold">-&gt;</span> failwith <span style="color:#b84">&#34;</span><span style="color:#b84">Remove not defined on an empty list</span><span style="color:#b84">&#34;</span>
    <span style="font-weight:bold">|</span> h1<span style="font-weight:bold">::</span>t1<span style="font-weight:bold">,</span> h2<span style="font-weight:bold">::</span>t2  <span style="font-weight:bold">when</span> h1 <span style="font-weight:bold">=</span> h2  <span style="font-weight:bold">-&gt;</span> remove t1 t2
    <span style="font-weight:bold">|</span> <span style="font-weight:bold">_</span><span style="font-weight:bold">,</span> <span style="font-weight:bold">_</span>              <span style="font-weight:bold">-&gt;</span> failwith <span style="color:#b84">&#34;</span><span style="color:#b84">itemsToRemove are not in the list</span><span style="color:#b84">&#34;</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">isOpening</span> options       <span style="font-weight:bold">=</span> startWith <span style="font-weight:bold">(</span><span style="color:#555">List</span>.ofSeq options<span style="font-weight:bold">.</span>startNarrative<span style="font-weight:bold">)</span> 
<span style="font-weight:bold">let</span> <span style="color:#008080">isClosing</span> options       <span style="font-weight:bold">=</span> startWith <span style="font-weight:bold">(</span><span style="color:#555">List</span>.ofSeq options<span style="font-weight:bold">.</span>endNarrative<span style="font-weight:bold">)</span>
<span style="font-weight:bold">let</span> <span style="color:#008080">remainingOpen</span> options   <span style="font-weight:bold">=</span> remove <span style="font-weight:bold">(</span><span style="color:#555">List</span>.ofSeq options<span style="font-weight:bold">.</span>startNarrative<span style="font-weight:bold">)</span>
<span style="font-weight:bold">let</span> <span style="color:#008080">remainingClose</span> options  <span style="font-weight:bold">=</span> remove <span style="font-weight:bold">(</span><span style="color:#555">List</span>.ofSeq options<span style="font-weight:bold">.</span>endNarrative<span style="font-weight:bold">)</span>
</code></pre></div><p>This is a pretty basic tokenizer. It just analyzes the start of the text and returns what it finds.
It also keeps track of the line number for the sake of reporting it in the error message.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">NL</span> <span style="font-weight:bold">=</span> <span style="color:#555">System</span>.<span style="color:#555">Environment</span>.NewLine

<span style="font-weight:bold">type</span> <span style="color:#458;font-weight:bold">Token</span> <span style="font-weight:bold">=</span>
<span style="font-weight:bold">|</span> OpenComment   <span style="font-weight:bold">of</span> int
<span style="font-weight:bold">|</span> CloseComment  <span style="font-weight:bold">of</span> int
<span style="font-weight:bold">|</span> Text          <span style="font-weight:bold">of</span> <span style="color:#458;font-weight:bold">string</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">tokenize</span> options source <span style="font-weight:bold">=</span>

    <span style="font-weight:bold">let</span> <span style="color:#008080">startWithNL</span> <span style="font-weight:bold">=</span> startWith <span style="font-weight:bold">(</span><span style="color:#555">Seq</span>.toList NL<span style="font-weight:bold">)</span>

    <span style="font-weight:bold">let</span> <span style="color:#008080">rec</span> text line acc <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
        <span style="font-weight:bold">|</span> t <span style="font-weight:bold">when</span> isOpening options t    <span style="font-weight:bold">-&gt;</span> line<span style="font-weight:bold">,</span> acc<span style="font-weight:bold">,</span> t 
        <span style="font-weight:bold">|</span> t <span style="font-weight:bold">when</span> isClosing options t    <span style="font-weight:bold">-&gt;</span> line<span style="font-weight:bold">,</span> acc<span style="font-weight:bold">,</span> t
        <span style="font-weight:bold">|</span> c <span style="font-weight:bold">::</span> t <span style="font-weight:bold">as</span> full                <span style="font-weight:bold">-&gt;</span>
            <span style="font-weight:bold">let</span> <span style="color:#008080">line</span><span style="font-weight:bold">&#39;</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">if</span> startWithNL full <span style="font-weight:bold">then</span> line <span style="font-weight:bold">+</span> 1 <span style="font-weight:bold">else</span> line
            text line&#39; <span style="font-weight:bold">(</span>acc <span style="font-weight:bold">+</span> c<span style="font-weight:bold">.</span>ToString()<span style="font-weight:bold">)</span> t
        <span style="font-weight:bold">|</span> []                            <span style="font-weight:bold">-&gt;</span> line<span style="font-weight:bold">,</span> acc<span style="font-weight:bold">,</span> [] 
    <span style="font-weight:bold">let</span> <span style="color:#008080">rec</span> tokenize&#39; line acc <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
        <span style="font-weight:bold">|</span> []                            <span style="font-weight:bold">-&gt;</span> <span style="color:#555">List</span>.rev acc
        <span style="font-weight:bold">|</span> t <span style="font-weight:bold">when</span> isOpening options t    <span style="font-weight:bold">-&gt;</span> tokenize&#39; line
                                            <span style="font-weight:bold">(</span>OpenComment<span style="font-weight:bold">(</span>line<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>acc<span style="font-weight:bold">)</span>  <span style="font-weight:bold">(</span>remainingOpen options t<span style="font-weight:bold">)</span>
        <span style="font-weight:bold">|</span> t <span style="font-weight:bold">when</span> isClosing options t    <span style="font-weight:bold">-&gt;</span> tokenize&#39; line
                                            <span style="font-weight:bold">(</span>CloseComment<span style="font-weight:bold">(</span>line<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>acc<span style="font-weight:bold">)</span> <span style="font-weight:bold">(</span>remainingClose options t<span style="font-weight:bold">)</span>
        <span style="font-weight:bold">|</span> t                             <span style="font-weight:bold">-&gt;</span>
            <span style="font-weight:bold">let</span> <span style="color:#008080">line</span><span style="font-weight:bold">,</span> s<span style="font-weight:bold">,</span> t&#39;<span style="font-weight:bold">=</span> text line <span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span> t
            tokenize&#39; line <span style="font-weight:bold">(</span>Text<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span> <span style="font-weight:bold">::</span> acc<span style="font-weight:bold">)</span> t&#39;

    tokenize&#39; 1 [] <span style="font-weight:bold">(</span><span style="color:#555">List</span>.ofSeq source<span style="font-weight:bold">)</span>
</code></pre></div><p>###Parser</p>
<p>The parse tree is just a list of Chunks, where a chunk can be a piece of narrative or a piece of code.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">type</span> <span style="color:#458;font-weight:bold">Chunk</span> <span style="font-weight:bold">=</span>
<span style="font-weight:bold">|</span> NarrativeChunk    <span style="font-weight:bold">of</span> Token <span style="color:#458;font-weight:bold">list</span>
<span style="font-weight:bold">|</span> CodeChunk         <span style="font-weight:bold">of</span> Token <span style="color:#458;font-weight:bold">list</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">parse</span> options source <span style="font-weight:bold">=</span>

    <span style="font-weight:bold">let</span> <span style="color:#008080">rec</span> parseNarrative acc <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
        <span style="font-weight:bold">|</span> OpenComment<span style="font-weight:bold">(</span>l<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t         <span style="font-weight:bold">-&gt;</span>
            failwith <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">Don&#39;t open narrative comments inside narrative comments at line </span><span style="color:#b84">&#34;</span>
                                                                                    <span style="font-weight:bold">+</span> l<span style="font-weight:bold">.</span>ToString()<span style="font-weight:bold">)</span>
        <span style="font-weight:bold">|</span> CloseComment<span style="font-weight:bold">(</span><span style="font-weight:bold">_</span><span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t        <span style="font-weight:bold">-&gt;</span> acc<span style="font-weight:bold">,</span> t
        <span style="font-weight:bold">|</span> Text<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t                <span style="font-weight:bold">-&gt;</span> parseNarrative <span style="font-weight:bold">(</span>Text<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>acc<span style="font-weight:bold">)</span> t
        <span style="font-weight:bold">|</span> []                        <span style="font-weight:bold">-&gt;</span> failwith <span style="color:#b84">&#34;</span><span style="color:#b84">You haven&#39;t closed your last narrative comment</span><span style="color:#b84">&#34;</span>

    <span style="font-weight:bold">let</span> <span style="color:#008080">rec</span> parseCode acc <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
        <span style="font-weight:bold">|</span> OpenComment<span style="font-weight:bold">(</span><span style="font-weight:bold">_</span><span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t <span style="font-weight:bold">as</span> t&#39;   <span style="font-weight:bold">-&gt;</span> acc<span style="font-weight:bold">,</span> t&#39;
        <span style="font-weight:bold">|</span> CloseComment<span style="font-weight:bold">(</span>l<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t        <span style="font-weight:bold">-&gt;</span> parseCode <span style="font-weight:bold">(</span>CloseComment<span style="font-weight:bold">(</span>l<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>acc<span style="font-weight:bold">)</span> t
        <span style="font-weight:bold">|</span> Text<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t                <span style="font-weight:bold">-&gt;</span> parseCode <span style="font-weight:bold">(</span>Text<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>acc<span style="font-weight:bold">)</span> t
        <span style="font-weight:bold">|</span> []                        <span style="font-weight:bold">-&gt;</span> acc<span style="font-weight:bold">,</span> []
    <span style="font-weight:bold">let</span> <span style="color:#008080">rec</span> parse&#39; acc <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
        <span style="font-weight:bold">|</span> OpenComment<span style="font-weight:bold">(</span><span style="font-weight:bold">_</span><span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t         <span style="font-weight:bold">-&gt;</span>
            <span style="font-weight:bold">let</span> <span style="color:#008080">narrative</span><span style="font-weight:bold">,</span> t&#39; <span style="font-weight:bold">=</span> parseNarrative [] t
            parse&#39; <span style="font-weight:bold">(</span>NarrativeChunk<span style="font-weight:bold">(</span>narrative<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>acc<span style="font-weight:bold">)</span> t&#39; 
        <span style="font-weight:bold">|</span> Text<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t                <span style="font-weight:bold">-&gt;</span>
            <span style="font-weight:bold">let</span> <span style="color:#008080">code</span><span style="font-weight:bold">,</span> t&#39; <span style="font-weight:bold">=</span> parseCode <span style="font-weight:bold">[</span>Text<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span><span style="font-weight:bold">]</span> t
            parse&#39; <span style="font-weight:bold">(</span>CodeChunk<span style="font-weight:bold">(</span>code<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>acc<span style="font-weight:bold">)</span> t&#39;
        <span style="font-weight:bold">|</span> CloseComment<span style="font-weight:bold">(</span>l<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t           <span style="font-weight:bold">-&gt;</span>
            failwith <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">Don&#39;t insert a close narrative comment at the start of your program at line </span><span style="color:#b84">&#34;</span>
                                                                                    <span style="font-weight:bold">+</span> l<span style="font-weight:bold">.</span>ToString()<span style="font-weight:bold">)</span>
        <span style="font-weight:bold">|</span> []                <span style="font-weight:bold">-&gt;</span> <span style="color:#555">List</span>.rev acc

    parse&#39; [] <span style="font-weight:bold">(</span><span style="color:#555">List</span>.ofSeq source<span style="font-weight:bold">)</span>
</code></pre></div><p>###Flattener</p>
<p>The flattening part of the algorithm is a bit unusual. At this point we have a parse tree that contains tokens, but we want
to reduce it to two simple node types containing all the text in string form.</p>
<p>TODO: consider managing nested comments and comments in strings (the latter has to happen in earlier phases)</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">flatten</span> options chunks <span style="font-weight:bold">=</span>
    <span style="font-weight:bold">let</span> <span style="color:#008080">tokenToStringNarrative</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
    <span style="font-weight:bold">|</span> OpenComment<span style="font-weight:bold">(</span>l<span style="font-weight:bold">)</span> <span style="font-weight:bold">|</span> CloseComment<span style="font-weight:bold">(</span>l<span style="font-weight:bold">)</span>  <span style="font-weight:bold">-&gt;</span> failwith <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">Narrative comments cannot be nested at line </span><span style="color:#b84">&#34;</span>
                                                                                    <span style="font-weight:bold">+</span> l<span style="font-weight:bold">.</span>ToString()<span style="font-weight:bold">)</span>
    <span style="font-weight:bold">|</span> Text<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span>                           <span style="font-weight:bold">-&gt;</span> s

    <span style="font-weight:bold">let</span> <span style="color:#008080">tokenToStringCode</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
    <span style="font-weight:bold">|</span> OpenComment<span style="font-weight:bold">(</span>l<span style="font-weight:bold">)</span>                <span style="font-weight:bold">-&gt;</span> failwith <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">Open narrative comment cannot be in code at line</span><span style="color:#b84">&#34;</span>
                                                                <span style="font-weight:bold">+</span> l<span style="font-weight:bold">.</span>ToString()<span style="font-weight:bold">)</span> <span style="font-weight:bold">+</span>
                                                 <span style="color:#b84">&#34;</span><span style="color:#b84">. Perhaps you have an open comment in</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">+</span>
                                                 <span style="color:#b84">&#34;</span><span style="color:#b84"> a code string before this comment tag?</span><span style="color:#b84">&#34;</span>
    <span style="font-weight:bold">|</span> CloseComment<span style="font-weight:bold">(</span><span style="font-weight:bold">_</span><span style="font-weight:bold">)</span>               <span style="font-weight:bold">-&gt;</span> <span style="color:#458;font-weight:bold">string</span><span style="font-weight:bold">(</span>options<span style="font-weight:bold">.</span>endNarrative <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.toArray<span style="font-weight:bold">)</span>
    <span style="font-weight:bold">|</span> Text<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span>                       <span style="font-weight:bold">-&gt;</span> s

    <span style="font-weight:bold">let</span> <span style="color:#008080">flattenChunk</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
    <span style="font-weight:bold">|</span> NarrativeChunk<span style="font-weight:bold">(</span>tokens<span style="font-weight:bold">)</span>             <span style="font-weight:bold">-&gt;</span>
        Narrative<span style="font-weight:bold">(</span>tokens <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.fold <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> state token <span style="font-weight:bold">-&gt;</span> state <span style="font-weight:bold">+</span> tokenToStringNarrative token<span style="font-weight:bold">)</span> <span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>
    <span style="font-weight:bold">|</span> CodeChunk<span style="font-weight:bold">(</span>tokens<span style="font-weight:bold">)</span>                  <span style="font-weight:bold">-&gt;</span>
        Code<span style="font-weight:bold">(</span>tokens <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.fold <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> state token <span style="font-weight:bold">-&gt;</span> state <span style="font-weight:bold">+</span> tokenToStringCode token<span style="font-weight:bold">)</span> <span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>

    chunks <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.fold <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> state chunk <span style="font-weight:bold">-&gt;</span> flattenChunk chunk <span style="font-weight:bold">::</span> state<span style="font-weight:bold">)</span> [] <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.rev
</code></pre></div><p>We are getting there, now we have a list of blocks we can operate upon</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">blockize <span style="font-weight:bold">:=</span> <span style="font-weight:bold">fun</span> options source <span style="font-weight:bold">-&gt;</span> source <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> tokenize options <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> parse options <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> flatten options
 
</code></pre></div><h2 id="narrative-comments-phases">Narrative comments phases</h2>
<p>Each phase is a function that takes the options and a block list and returns a block list that has been &lsquo;processed&rsquo;
in some way.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">type</span> <span style="color:#458;font-weight:bold">Phase</span> <span style="font-weight:bold">=</span> Options <span style="font-weight:bold">-&gt;</span> Block List <span style="font-weight:bold">-&gt;</span> Block List

<span style="font-weight:bold">let</span> <span style="color:#008080">removeEmptyBlocks</span>   <span style="font-weight:bold">=</span> declare<span style="font-weight:bold">&lt;</span>Phase<span style="font-weight:bold">&gt;</span>
<span style="font-weight:bold">let</span> <span style="color:#008080">mergeBlocks</span>         <span style="font-weight:bold">=</span> declare<span style="font-weight:bold">&lt;</span>Phase<span style="font-weight:bold">&gt;</span>
<span style="font-weight:bold">let</span> <span style="color:#008080">addCodeTags</span>         <span style="font-weight:bold">=</span> declare<span style="font-weight:bold">&lt;</span>Phase<span style="font-weight:bold">&gt;</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">processPhases</span> options blockList <span style="font-weight:bold">=</span> 
    blockList
    <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">!</span>removeEmptyBlocks   options
    <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">!</span>mergeBlocks         options
    <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">!</span>addCodeTags         options
</code></pre></div><p>We want to manage how many newlines there are between different blocks, because we don&rsquo;t trust the programmer
to have a good view of how many newline to keep from comment blocks and code blocks.
We&rsquo;ll trim all newlines from the start and end of a block, and then add our own.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">newLines</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">[|</span><span style="color:#b84">&#39;\n&#39;</span><span style="font-weight:bold">;</span><span style="color:#b84">&#39;\r&#39;</span><span style="font-weight:bold">|]</span>

<span style="font-weight:bold">type</span> <span style="color:#458;font-weight:bold">System</span><span style="font-weight:bold">.</span>String <span style="font-weight:bold">with</span>
    <span style="font-weight:bold">member</span> s.<span style="color:#900;font-weight:bold">TrimNl</span> () <span style="font-weight:bold">=</span> s<span style="font-weight:bold">.</span>Trim<span style="font-weight:bold">(</span>newLines<span style="font-weight:bold">)</span> 
</code></pre></div><p>###Remove empty blocks</p>
<p>There might be empty blocks (i.e. between two consecutive comment blocks) in the file.
For the sake of formatting the file beautifully, we want to remove them.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">extract</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
    <span style="font-weight:bold">|</span> Code<span style="font-weight:bold">(</span>text<span style="font-weight:bold">)</span>        <span style="font-weight:bold">-&gt;</span> text
    <span style="font-weight:bold">|</span> Narrative<span style="font-weight:bold">(</span>text<span style="font-weight:bold">)</span>   <span style="font-weight:bold">-&gt;</span> text

removeEmptyBlocks <span style="font-weight:bold">:=</span> <span style="font-weight:bold">fun</span> options blocks <span style="font-weight:bold">-&gt;</span>
                        blocks <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.filter <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> b <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">(</span>extract b<span style="font-weight:bold">)</span><span style="font-weight:bold">.</span>TrimNl()<span style="font-weight:bold">.</span>Trim() <span style="font-weight:bold">&lt;</span><span style="font-weight:bold">&gt;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>
</code></pre></div><p>###Merge blocks</p>
<p>Consecutive blocks of the same kind need to be merged, for the sake of formatting the overall text correctly.</p>
<p>TODO: make tail recursive</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">rec</span> mergeBlockList <span style="font-weight:bold">=</span> <span style="font-weight:bold">function</span>
    <span style="font-weight:bold">|</span> []        <span style="font-weight:bold">-&gt;</span> []
    <span style="font-weight:bold">|</span> <span style="font-weight:bold">[</span>a<span style="font-weight:bold">]</span>       <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">[</span>a<span style="font-weight:bold">]</span>
    <span style="font-weight:bold">|</span> h1<span style="font-weight:bold">::</span>h2<span style="font-weight:bold">::</span>t <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">match</span> h1<span style="font-weight:bold">,</span> h2 <span style="font-weight:bold">with</span>
                   <span style="font-weight:bold">|</span> Code<span style="font-weight:bold">(</span>t1<span style="font-weight:bold">)</span><span style="font-weight:bold">,</span> Code<span style="font-weight:bold">(</span>t2<span style="font-weight:bold">)</span>             <span style="font-weight:bold">-&gt;</span> mergeBlockList <span style="font-weight:bold">(</span>Code<span style="font-weight:bold">(</span>t1 <span style="font-weight:bold">+</span> NL <span style="font-weight:bold">+</span> t2<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t<span style="font-weight:bold">)</span>
                   <span style="font-weight:bold">|</span> Narrative<span style="font-weight:bold">(</span>n1<span style="font-weight:bold">)</span><span style="font-weight:bold">,</span> Narrative<span style="font-weight:bold">(</span>n2<span style="font-weight:bold">)</span>   <span style="font-weight:bold">-&gt;</span> mergeBlockList<span style="font-weight:bold">(</span>Narrative<span style="font-weight:bold">(</span>n1 <span style="font-weight:bold">+</span> NL <span style="font-weight:bold">+</span> n2<span style="font-weight:bold">)</span><span style="font-weight:bold">::</span>t<span style="font-weight:bold">)</span>
                   <span style="font-weight:bold">|</span> <span style="font-weight:bold">_</span><span style="font-weight:bold">,</span> <span style="font-weight:bold">_</span>                           <span style="font-weight:bold">-&gt;</span> h1<span style="font-weight:bold">::</span>mergeBlockList<span style="font-weight:bold">(</span>h2<span style="font-weight:bold">::</span>t<span style="font-weight:bold">)</span>

mergeBlocks <span style="font-weight:bold">:=</span> <span style="font-weight:bold">fun</span> options blocks <span style="font-weight:bold">-&gt;</span> mergeBlockList blocks
</code></pre></div><p>###Adding code tags</p>
<p>Each code block needs a tag at the start and one at the end or it needs to be indented by N chars.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">indent</span> n <span style="font-weight:bold">(</span>s<span style="font-weight:bold">:</span><span style="color:#458;font-weight:bold">string</span><span style="font-weight:bold">)</span> <span style="font-weight:bold">=</span>
    <span style="font-weight:bold">let</span> <span style="color:#008080">pad</span> <span style="font-weight:bold">=</span> <span style="color:#555">String</span>.replicate n <span style="color:#b84">&#34;</span><span style="color:#b84"> </span><span style="color:#b84">&#34;</span>
    pad <span style="font-weight:bold">+</span> s<span style="font-weight:bold">.</span>Replace<span style="font-weight:bold">(</span>NL<span style="font-weight:bold">,</span> NL <span style="font-weight:bold">+</span> pad<span style="font-weight:bold">)</span>

addCodeTags <span style="font-weight:bold">:=</span> <span style="font-weight:bold">fun</span> options blocks <span style="font-weight:bold">-&gt;</span>
    <span style="font-weight:bold">match</span> options<span style="font-weight:bold">.</span>codeSymbols <span style="font-weight:bold">with</span>
    <span style="font-weight:bold">|</span> Indent<span style="font-weight:bold">(</span>n<span style="font-weight:bold">)</span>         <span style="font-weight:bold">-&gt;</span>
        blocks <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.map <span style="font-weight:bold">(</span><span style="font-weight:bold">function</span> Narrative<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span> <span style="font-weight:bold">as</span> nar <span style="font-weight:bold">-&gt;</span> nar <span style="font-weight:bold">|</span> Code<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> Code<span style="font-weight:bold">(</span>indent n s<span style="font-weight:bold">)</span><span style="font-weight:bold">)</span>
    <span style="font-weight:bold">|</span> Surrounded<span style="font-weight:bold">(</span>s<span style="font-weight:bold">,</span> e<span style="font-weight:bold">)</span>  <span style="font-weight:bold">-&gt;</span> 
        blocks <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.map <span style="font-weight:bold">(</span><span style="font-weight:bold">function</span>
                            <span style="font-weight:bold">|</span> Narrative<span style="font-weight:bold">(</span>text<span style="font-weight:bold">)</span>   <span style="font-weight:bold">-&gt;</span> Narrative<span style="font-weight:bold">(</span>NL <span style="font-weight:bold">+</span> text<span style="font-weight:bold">.</span>TrimNl() <span style="font-weight:bold">+</span> NL<span style="font-weight:bold">)</span>
                            <span style="font-weight:bold">|</span> Code<span style="font-weight:bold">(</span>text<span style="font-weight:bold">)</span>        <span style="font-weight:bold">-&gt;</span> Code<span style="font-weight:bold">(</span>NL <span style="font-weight:bold">+</span> s <span style="font-weight:bold">+</span> NL <span style="font-weight:bold">+</span> text<span style="font-weight:bold">.</span>TrimNl() <span style="font-weight:bold">+</span> NL <span style="font-weight:bold">+</span> e <span style="font-weight:bold">+</span> NL<span style="font-weight:bold">)</span><span style="font-weight:bold">)</span>
</code></pre></div><p>###Flatten again</p>
<p>Once we have the array of blocks, we need to flatten them (transform them in a single string),
which is trivial, and then finally implement our original translate function.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">sumBlock</span> s b2 <span style="font-weight:bold">=</span> s <span style="font-weight:bold">+</span> extract b2

<span style="font-weight:bold">let</span> <span style="color:#008080">flattenB</span> blocks <span style="font-weight:bold">=</span> <span style="font-weight:bold">(</span>blocks <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.fold sumBlock <span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span><span style="font-weight:bold">.</span>TrimStart<span style="font-weight:bold">(</span>newLines<span style="font-weight:bold">)</span>

translate <span style="font-weight:bold">:=</span> <span style="font-weight:bold">fun</span> options text <span style="font-weight:bold">-&gt;</span> text <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">!</span>blockize options <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> processPhases options <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> flattenB
</code></pre></div><h2 id="parsing-command-line-arguments">Parsing command line arguments</h2>
<p>Parsing command lines involves writing a function that goes from a sequence of strings
to an input file name, output file name and Options record</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">parseCommandLine</span> <span style="font-weight:bold">=</span> declare<span style="font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">string</span> array <span style="font-weight:bold">-&gt;</span> <span style="color:#458;font-weight:bold">string</span> <span style="font-weight:bold">*</span> <span style="color:#458;font-weight:bold">string</span> <span style="font-weight:bold">*</span> Options<span style="font-weight:bold">&gt;</span>
</code></pre></div><p>To implement it, we are going to use a command line parser taken from <a href="http://fssnip.net/8g">here</a>. The parseArgs function takes a sequence of argument values
and map them into a (name,value) tuple. It scans the tuple sequence and put command name into all subsequent tuples without name and discard the initial (&quot;&quot;,&quot;&quot;) tuple.
It then groups tuples by name and converts the tuple sequence into a map of (name,value seq)</p>
<p>For now, I don&rsquo;t need the &lsquo;value seq&rsquo; part as all my parameters take a single argument, but I left it in there in case I will need to pass multiple args later on.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">open</span>  <span style="color:#555">System.Text.RegularExpressions</span>

<span style="font-weight:bold">let</span> <span style="font-weight:bold">(</span><span style="font-weight:bold">|</span>Command<span style="font-weight:bold">|</span><span style="font-weight:bold">_</span><span style="font-weight:bold">|</span><span style="font-weight:bold">)</span> <span style="font-weight:bold">(</span>s<span style="font-weight:bold">:</span><span style="color:#458;font-weight:bold">string</span><span style="font-weight:bold">)</span> <span style="font-weight:bold">=</span>
  <span style="font-weight:bold">let</span> <span style="color:#008080">r</span> <span style="font-weight:bold">=</span> <span style="font-weight:bold">new</span> Regex<span style="font-weight:bold">(</span><span style="color:#b84">@&#34;</span><span style="color:#b84">^(?:-{1,2}|\/)(?&lt;command&gt;\w+)[=:]*(?&lt;value&gt;.*)$</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span><span style="color:#555">RegexOptions</span>.IgnoreCase<span style="font-weight:bold">)</span>
  <span style="font-weight:bold">let</span> <span style="color:#008080">m</span> <span style="font-weight:bold">=</span> r<span style="font-weight:bold">.</span>Match<span style="font-weight:bold">(</span>s<span style="font-weight:bold">)</span>
  <span style="font-weight:bold">if</span> m<span style="font-weight:bold">.</span>Success
  <span style="font-weight:bold">then</span> 
    Some<span style="font-weight:bold">(</span>m<span style="font-weight:bold">.</span>Groups<span style="font-weight:bold">.</span><span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">command</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span><span style="font-weight:bold">.</span>Value<span style="font-weight:bold">.</span>ToLower()<span style="font-weight:bold">,</span> m<span style="font-weight:bold">.</span>Groups<span style="font-weight:bold">.</span><span style="font-weight:bold">[</span><span style="color:#b84">&#34;</span><span style="color:#b84">value</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">]</span><span style="font-weight:bold">.</span>Value<span style="font-weight:bold">)</span>
  <span style="font-weight:bold">else</span>
    None


<span style="font-weight:bold">let</span> <span style="color:#008080">parseArgs</span> <span style="font-weight:bold">(</span>args<span style="font-weight:bold">:</span><span style="color:#458;font-weight:bold">string</span> seq<span style="font-weight:bold">)</span> <span style="font-weight:bold">=</span>
  args 
  <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.map <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> i <span style="font-weight:bold">-&gt;</span> 
                    <span style="font-weight:bold">match</span> i <span style="font-weight:bold">with</span>
                    <span style="font-weight:bold">|</span> Command <span style="font-weight:bold">(</span>n<span style="font-weight:bold">,</span>v<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">(</span>n<span style="font-weight:bold">,</span>v<span style="font-weight:bold">)</span> <span style="color:#998;font-style:italic">// command
</span><span style="color:#998;font-style:italic"></span>                    <span style="font-weight:bold">|</span> <span style="font-weight:bold">_</span> <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span>i<span style="font-weight:bold">)</span>            <span style="color:#998;font-style:italic">// data
</span><span style="color:#998;font-style:italic"></span>                  <span style="font-weight:bold">)</span>
  <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.scan <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> <span style="font-weight:bold">(</span>sn<span style="font-weight:bold">,</span><span style="font-weight:bold">_</span><span style="font-weight:bold">)</span> <span style="font-weight:bold">(</span>n<span style="font-weight:bold">,</span>v<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">if</span> n<span style="font-weight:bold">.</span>Length<span style="font-weight:bold">&gt;</span>0 <span style="font-weight:bold">then</span> <span style="font-weight:bold">(</span>n<span style="font-weight:bold">,</span>v<span style="font-weight:bold">)</span> <span style="font-weight:bold">else</span> <span style="font-weight:bold">(</span>sn<span style="font-weight:bold">,</span>v<span style="font-weight:bold">)</span><span style="font-weight:bold">)</span> <span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span><span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>
  <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.skip 1
  <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.groupBy <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> <span style="font-weight:bold">(</span>n<span style="font-weight:bold">,</span><span style="font-weight:bold">_</span><span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> n<span style="font-weight:bold">)</span>
  <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.map <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> <span style="font-weight:bold">(</span>n<span style="font-weight:bold">,</span>s<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">(</span>n<span style="font-weight:bold">,</span> s <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.map <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> <span style="font-weight:bold">(</span><span style="font-weight:bold">_</span><span style="font-weight:bold">,</span>v<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> v<span style="font-weight:bold">)</span> <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.filter <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> i <span style="font-weight:bold">-&gt;</span> i<span style="font-weight:bold">.</span>Length<span style="font-weight:bold">&gt;</span>0<span style="font-weight:bold">)</span><span style="font-weight:bold">)</span><span style="font-weight:bold">)</span>
  <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Map</span>.ofSeq

<span style="font-weight:bold">let</span> <span style="color:#008080">paramRetrieve</span> <span style="font-weight:bold">(</span>m<span style="font-weight:bold">:</span>Map<span style="font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">string</span><span style="font-weight:bold">,</span><span style="font-weight:bold">_</span><span style="font-weight:bold">&gt;</span><span style="font-weight:bold">)</span> <span style="font-weight:bold">(</span>p<span style="font-weight:bold">:</span><span style="color:#458;font-weight:bold">string</span><span style="font-weight:bold">)</span> <span style="font-weight:bold">=</span> 
  <span style="font-weight:bold">if</span> <span style="color:#555">Map</span>.containsKey p m
  <span style="font-weight:bold">then</span> Some<span style="font-weight:bold">(</span>m<span style="font-weight:bold">.</span><span style="font-weight:bold">[</span>p<span style="font-weight:bold">]</span><span style="font-weight:bold">)</span>
  <span style="font-weight:bold">else</span> None
</code></pre></div><p>This is the main logic of parameter passing. Note that we give precedence to the -l and -indent parameters, if present.</p>
<p>This is a function that goes from the map of command line parameters to the input file name, output file name and options. With that we
can finally define the original parseCommandLine.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">safeHead</span> errMsg s <span style="font-weight:bold">=</span> <span style="font-weight:bold">if</span> s <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.isEmpty <span style="font-weight:bold">then</span> failwith errMsg <span style="font-weight:bold">else</span> s <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.head 

<span style="font-weight:bold">let</span> <span style="color:#008080">paramsToInputs</span> paramsMap <span style="font-weight:bold">=</span>
    <span style="font-weight:bold">let</span> <span style="color:#008080">single</span> p er     <span style="font-weight:bold">=</span> <span style="font-weight:bold">match</span> paramRetrieve paramsMap p <span style="font-weight:bold">with</span> <span style="font-weight:bold">|</span> Some<span style="font-weight:bold">(</span>k<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> Some<span style="font-weight:bold">(</span>k <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> safeHead er<span style="font-weight:bold">)</span>
                                                               <span style="font-weight:bold">|</span> None <span style="font-weight:bold">-&gt;</span> None
    <span style="font-weight:bold">let</span> <span style="color:#008080">get</span> p s         <span style="font-weight:bold">=</span> <span style="font-weight:bold">match</span> paramRetrieve paramsMap p <span style="font-weight:bold">with</span> <span style="font-weight:bold">|</span>Some<span style="font-weight:bold">(</span>k<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> k <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> safeHead s
                                                               <span style="font-weight:bold">|</span> None <span style="font-weight:bold">-&gt;</span> failwith s
    <span style="font-weight:bold">let</span> <span style="color:#008080">defaultP</span> p q er <span style="font-weight:bold">=</span> <span style="font-weight:bold">match</span> paramRetrieve paramsMap p <span style="font-weight:bold">with</span> <span style="font-weight:bold">|</span> Some<span style="font-weight:bold">(</span>k<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> k <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> safeHead er
                                                               <span style="font-weight:bold">|</span> None <span style="font-weight:bold">-&gt;</span> q

    <span style="font-weight:bold">let</span> <span style="color:#008080">inputFile</span>       <span style="font-weight:bold">=</span> get <span style="color:#b84">&#34;</span><span style="color:#b84">&#34;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">You need to pass an input file</span><span style="color:#b84">&#34;</span>
    <span style="font-weight:bold">let</span> <span style="color:#008080">outputFile</span>      <span style="font-weight:bold">=</span> defaultP  <span style="color:#b84">&#34;</span><span style="color:#b84">o</span><span style="color:#b84">&#34;</span>
                                    <span style="font-weight:bold">(</span><span style="color:#555">System</span>.<span style="color:#555">IO</span>.<span style="color:#555">Path</span>.GetFileNameWithoutExtension<span style="font-weight:bold">(</span>inputFile<span style="font-weight:bold">:</span><span style="color:#458;font-weight:bold">string</span><span style="font-weight:bold">)</span> <span style="font-weight:bold">+</span> <span style="color:#b84">&#34;</span><span style="color:#b84">.mkd</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>
                                    <span style="color:#b84">&#34;</span><span style="color:#b84">You must pass a parameter to -o</span><span style="color:#b84">&#34;</span>

    <span style="font-weight:bold">let</span> <span style="color:#008080">no</span><span style="font-weight:bold">,</span> nc          <span style="font-weight:bold">=</span> <span style="font-weight:bold">match</span> <span style="color:#458;font-weight:bold">single</span> <span style="color:#b84">&#34;</span><span style="color:#b84">l</span><span style="color:#b84">&#34;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">You must pass a language parameter to -l</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">with</span>
                          <span style="font-weight:bold">|</span> Some<span style="font-weight:bold">(</span>l<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> getLangNoNC l
                          <span style="font-weight:bold">|</span> None    <span style="font-weight:bold">-&gt;</span>
                                get <span style="color:#b84">&#34;</span><span style="color:#b84">no</span><span style="color:#b84">&#34;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">The no (narrative open) parameter is mandatory, if no -l specified</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span>
                                get <span style="color:#b84">&#34;</span><span style="color:#b84">nc</span><span style="color:#b84">&#34;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">The nc (narrative close) parameter is mandatory, if no -l specified</span><span style="color:#b84">&#34;</span>

    <span style="font-weight:bold">let</span> <span style="color:#008080">codeSymbs</span>       <span style="font-weight:bold">=</span> <span style="font-weight:bold">match</span> <span style="color:#458;font-weight:bold">single</span> <span style="color:#b84">&#34;</span><span style="color:#b84">indent</span><span style="color:#b84">&#34;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">You must pass a whitespace indentation number to -indent</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">with</span>
                          <span style="font-weight:bold">|</span> Some<span style="font-weight:bold">(</span>n<span style="font-weight:bold">)</span>     <span style="font-weight:bold">-&gt;</span>
                                <span style="font-weight:bold">let</span> <span style="color:#008080">success</span><span style="font-weight:bold">,</span> value <span style="font-weight:bold">=</span> <span style="color:#555">System</span>.<span style="color:#555">Int32</span>.TryParse n
                                <span style="font-weight:bold">if</span> success
                                    <span style="font-weight:bold">then</span> Indent<span style="font-weight:bold">(</span>value<span style="font-weight:bold">)</span>
                                    <span style="font-weight:bold">else</span> failwith <span style="color:#b84">&#34;</span><span style="color:#b84">-i accepts just an integer value as parameter</span><span style="color:#b84">&#34;</span>                          
                          <span style="font-weight:bold">|</span> None        <span style="font-weight:bold">-&gt;</span>
                                <span style="font-weight:bold">match</span> <span style="color:#458;font-weight:bold">single</span> <span style="color:#b84">&#34;</span><span style="color:#b84">l</span><span style="color:#b84">&#34;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">You must pass a language parameter to -l</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">with</span>
                                <span style="font-weight:bold">|</span> Some<span style="font-weight:bold">(</span>l<span style="font-weight:bold">)</span> <span style="font-weight:bold">-&gt;</span> Surrounded<span style="font-weight:bold">(</span><span style="color:#b84">&#34;</span><span style="color:#b84">~~~</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">+</span> l<span style="font-weight:bold">,</span><span style="color:#b84">&#34;</span><span style="color:#b84">~~~</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>
                                <span style="font-weight:bold">|</span> None    <span style="font-weight:bold">-&gt;</span>
                                    Surrounded<span style="font-weight:bold">(</span>
                                        get <span style="color:#b84">&#34;</span><span style="color:#b84">co</span><span style="color:#b84">&#34;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">The co (code open) parameter is mandatory, if no -indent specified</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">,</span>
                                        get <span style="color:#b84">&#34;</span><span style="color:#b84">cc</span><span style="color:#b84">&#34;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">The cc (code close) parameter is mandatory</span><span style="color:#b84">&#34;</span><span style="font-weight:bold">)</span>
    inputFile<span style="font-weight:bold">,</span> outputFile<span style="font-weight:bold">,</span> <span style="font-weight:bold">{</span>
        startNarrative  <span style="font-weight:bold">=</span> no
        endNarrative    <span style="font-weight:bold">=</span> nc
        codeSymbols     <span style="font-weight:bold">=</span> codeSymbs
        <span style="font-weight:bold">}</span>

parseCommandLine <span style="font-weight:bold">:=</span> parseArgs <span style="font-weight:bold">&gt;</span><span style="font-weight:bold">&gt;</span> paramsToInputs
</code></pre></div><h2 id="main-method">Main method</h2>
<p>We can then write main as the only side effect function in the program. Here is where the IO monad would live &hellip;</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">banner</span>  <span style="font-weight:bold">=</span> <span style="color:#b84">&#34;</span><span style="color:#b84">LLite : language friendly literate programming</span><span style="color:#b84">\n</span><span style="color:#b84">&#34;</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">printMemory</span> () <span style="font-weight:bold">=</span>
    <span style="font-weight:bold">let</span> <span style="color:#008080">bytesInMeg</span> <span style="font-weight:bold">=</span> 1048576<span style="font-weight:bold">.</span>
    <span style="font-weight:bold">let</span> <span style="color:#008080">peak</span> <span style="font-weight:bold">=</span> <span style="color:#555">System</span>.<span style="color:#555">Diagnostics</span>.<span style="color:#555">Process</span>.GetCurrentProcess()<span style="font-weight:bold">.</span>PeakWorkingSet64
    <span style="font-weight:bold">let</span> <span style="color:#008080">work</span> <span style="font-weight:bold">=</span> <span style="color:#555">System</span>.<span style="color:#555">Diagnostics</span>.<span style="color:#555">Process</span>.GetCurrentProcess()<span style="font-weight:bold">.</span>WorkingSet64
    printfn <span style="color:#b84">&#34;</span><span style="color:#b84">Peak working set: %A</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">(</span><span style="font-weight:bold">(</span><span style="color:#458;font-weight:bold">float</span><span style="font-weight:bold">)</span> peak <span style="font-weight:bold">/</span> bytesInMeg<span style="font-weight:bold">)</span>
    printfn <span style="color:#b84">&#34;</span><span style="color:#b84">Working set: %A</span><span style="color:#b84">&#34;</span> <span style="font-weight:bold">(</span><span style="font-weight:bold">(</span><span style="color:#458;font-weight:bold">float</span><span style="font-weight:bold">)</span> peak <span style="font-weight:bold">/</span> bytesInMeg<span style="font-weight:bold">)</span>

<span style="font-weight:bold">let</span> <span style="color:#008080">myMain</span> args <span style="font-weight:bold">=</span>
        <span style="font-weight:bold">try</span>

            <span style="font-weight:bold">let</span> <span style="color:#008080">inputFile</span><span style="font-weight:bold">,</span> outputFile<span style="font-weight:bold">,</span> options <span style="font-weight:bold">=</span> <span style="font-weight:bold">!</span>parseCommandLine args
            <span style="font-weight:bold">let</span> <span style="color:#008080">input</span>       <span style="font-weight:bold">=</span> <span style="color:#555">System</span>.<span style="color:#555">IO</span>.<span style="color:#555">File</span>.ReadAllText inputFile
            <span style="font-weight:bold">let</span> <span style="color:#008080">output</span>      <span style="font-weight:bold">=</span> <span style="font-weight:bold">!</span>translate options input
            <span style="color:#555">System</span>.<span style="color:#555">IO</span>.<span style="color:#555">File</span>.WriteAllText <span style="font-weight:bold">(</span>outputFile<span style="font-weight:bold">,</span> output<span style="font-weight:bold">)</span>

            <span style="color:#998;font-style:italic">//printMemory ()
</span><span style="color:#998;font-style:italic"></span>            0
        <span style="font-weight:bold">with</span>
        <span style="font-weight:bold">|</span> e <span style="font-weight:bold">-&gt;</span>
            printfn <span style="color:#b84">&#34;</span><span style="color:#b84">%s</span><span style="color:#b84">&#34;</span> <span style="color:#b84">&#34;</span><span style="color:#b84">Failure</span><span style="color:#b84">&#34;</span>
            printfn <span style="color:#b84">&#34;</span><span style="color:#b84">%s</span><span style="color:#b84">&#34;</span> e<span style="font-weight:bold">.</span>Message 
            printfn <span style="color:#b84">&#34;</span><span style="color:#b84">%s</span><span style="color:#b84">&#34;</span> usage
    <span style="font-weight:bold">#</span><span style="font-weight:bold">if</span> DEBUG 
            printfn <span style="color:#b84">&#34;</span><span style="color:#b84">\n</span><span style="color:#b84">Detailed Error Below:</span><span style="color:#b84">\n</span><span style="color:#b84">%A</span><span style="color:#b84">&#34;</span> e
    <span style="font-weight:bold">#</span>endif
            <span style="font-weight:bold">-</span>1
</code></pre></div><h1 id="an-aside-forward-declaring-functions-in-f">An aside: forward declaring functions in F#</h1>
<h2 id="a-simple-solution">A simple solution</h2>
<p>You can achieve something somehow similar to forward declaration by the &lsquo;declare &lsquo;dirty trick used in this program.
Whenever you want to do a forward declaration of a function , or variable, you can type:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">let</span> <span style="color:#008080">testDeclare</span>() <span style="font-weight:bold">=</span>

    <span style="font-weight:bold">let</span> <span style="color:#008080">add</span> <span style="font-weight:bold">=</span> declare<span style="font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">float</span> <span style="font-weight:bold">-&gt;</span> <span style="color:#458;font-weight:bold">float</span><span style="font-weight:bold">&gt;</span>

    <span style="font-weight:bold">let</span> ``function where I want to use add without having defined it`` nums <span style="font-weight:bold">=</span> nums <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">Seq</span>.map <span style="font-weight:bold">!</span>add
</code></pre></div><p>This creates a ref to a function from float to float. It looks a bit like an Haskell type declaration.
You can then use such function as if it were actually define and delay his definition to a later point
in time when you are ready to explain it.</p>
<p>When you are ready to talk about it, you can then define it with:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">    add <span style="font-weight:bold">:=</span> <span style="font-weight:bold">fun</span> x <span style="font-weight:bold">-&gt;</span> x <span style="font-weight:bold">+</span> 1<span style="font-weight:bold">.</span>
</code></pre></div><p>The syntax is not too bad. You get that often-sought Haskell like explicit type declaration and you can
regex the codebase to create an index at the end of the program (maybe).</p>
<p>But is it too slow? After all, there is one more indirection call for each function call.</p>
<p>Let&rsquo;s test it: enable #time in F# interactive and execute timeNormalF and timeIndirectF varying sleepTime
and howManyIter until you convince yourself that it is ok (or not).</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">    <span style="font-weight:bold">let</span> <span style="color:#008080">sleepTime</span>   <span style="font-weight:bold">=</span> 50
    <span style="font-weight:bold">let</span> <span style="color:#008080">howManyIter</span> <span style="font-weight:bold">=</span> 100
    <span style="font-weight:bold">let</span> <span style="color:#008080">normalF</span> x   <span style="font-weight:bold">=</span> <span style="color:#555">System</span>.<span style="color:#555">Threading</span>.<span style="color:#555">Thread</span>.Sleep sleepTime
    <span style="font-weight:bold">let</span> <span style="color:#008080">indirectF</span>   <span style="font-weight:bold">=</span> declare<span style="font-weight:bold">&lt;</span>int <span style="font-weight:bold">-&gt;</span> <span style="color:#458;font-weight:bold">unit</span><span style="font-weight:bold">&gt;</span>
    indirectF      <span style="font-weight:bold">:=</span> <span style="font-weight:bold">fun</span> x <span style="font-weight:bold">-&gt;</span> <span style="color:#555">System</span>.<span style="color:#555">Threading</span>.<span style="color:#555">Thread</span>.Sleep sleepTime
     
    <span style="font-weight:bold">let</span> <span style="color:#008080">timeNormalF</span>     <span style="font-weight:bold">=</span> <span style="font-weight:bold">[</span>1<span style="font-weight:bold">..</span>howManyIter<span style="font-weight:bold">]</span> <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.iter normalF
    <span style="font-weight:bold">let</span> <span style="color:#008080">timeIndirectF</span>   <span style="font-weight:bold">=</span> <span style="font-weight:bold">[</span>1<span style="font-weight:bold">..</span>howManyIter<span style="font-weight:bold">]</span> <span style="font-weight:bold">|</span><span style="font-weight:bold">&gt;</span> <span style="color:#555">List</span>.iter <span style="font-weight:bold">!</span>indirectF
    ()
</code></pre></div><h2 id="a-correct-solution-but-ugly">A correct solution (but ugly)</h2>
<p>Unfortunately, there is a big problem with all of the above: it doesn&rsquo;t work with generic functions and curried function invocations.
The code below works in all cases, but it is ugly for the user to use. In this program I&rsquo;ve used the beautiful, but incorrect, syntax.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">type</span> <span style="color:#458;font-weight:bold">Literate</span>() <span style="font-weight:bold">=</span>
    <span style="font-weight:bold">static</span> <span style="font-weight:bold">member</span> Declare<span style="font-weight:bold">&lt;</span><span style="font-weight:bold">&#39;</span>a<span style="font-weight:bold">,</span> <span style="font-weight:bold">&#39;</span>b<span style="font-weight:bold">&gt;</span>  <span style="font-weight:bold">(</span>ref <span style="font-weight:bold">:</span> <span style="color:#458;font-weight:bold">obj</span> ref<span style="font-weight:bold">)</span> <span style="font-weight:bold">(</span>x <span style="font-weight:bold">:</span> <span style="font-weight:bold">&#39;</span>a<span style="font-weight:bold">)</span> <span style="font-weight:bold">:</span> <span style="font-weight:bold">&#39;</span>b <span style="font-weight:bold">=</span>
        unbox <span style="font-weight:bold">&lt;</span><span style="font-weight:bold">|</span> <span style="font-weight:bold">(</span>unbox<span style="font-weight:bold">&lt;</span><span style="color:#458;font-weight:bold">obj</span> <span style="font-weight:bold">-&gt;</span> <span style="color:#458;font-weight:bold">obj</span><span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">!</span>ref<span style="font-weight:bold">)</span> x
    <span style="font-weight:bold">static</span> <span style="font-weight:bold">member</span> Define<span style="font-weight:bold">&lt;</span><span style="font-weight:bold">&#39;</span>a<span style="font-weight:bold">,</span> <span style="font-weight:bold">&#39;</span>b<span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">(</span>func <span style="font-weight:bold">:</span> <span style="font-weight:bold">&#39;</span>a <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">&#39;</span>b<span style="font-weight:bold">)</span> <span style="font-weight:bold">(</span>ref <span style="font-weight:bold">:</span> <span style="color:#458;font-weight:bold">obj</span> ref<span style="font-weight:bold">)</span> <span style="font-weight:bold">(</span>f <span style="font-weight:bold">:</span> <span style="font-weight:bold">&#39;</span>a <span style="font-weight:bold">-&gt;</span> <span style="font-weight:bold">&#39;</span>b<span style="font-weight:bold">)</span> <span style="font-weight:bold">=</span>
        ref <span style="font-weight:bold">:=</span> box <span style="font-weight:bold">(</span>unbox<span style="font-weight:bold">&lt;</span><span style="font-weight:bold">&#39;</span>a<span style="font-weight:bold">&gt;</span> <span style="font-weight:bold">&gt;</span><span style="font-weight:bold">&gt;</span> f <span style="font-weight:bold">&gt;</span><span style="font-weight:bold">&gt;</span> box<span style="font-weight:bold">)</span>

<span style="color:#998;font-style:italic">// Declaration    
</span><span style="color:#998;font-style:italic"></span><span style="font-weight:bold">let</span> <span style="color:#008080">rec</span> id <span style="font-weight:bold">(</span>x <span style="font-weight:bold">:</span> <span style="font-weight:bold">&#39;</span>a<span style="font-weight:bold">)</span> <span style="font-weight:bold">:</span> <span style="font-weight:bold">&#39;</span>a <span style="font-weight:bold">=</span> <span style="color:#555">Literate</span>.Declare idImpl x
<span style="font-weight:bold">and</span> idImpl <span style="font-weight:bold">=</span> ref <span style="font-weight:bold">null</span>

<span style="color:#998;font-style:italic">// Usage
</span><span style="color:#998;font-style:italic"></span><span style="font-weight:bold">let</span> <span style="color:#008080">f</span> () <span style="font-weight:bold">=</span> id 100 <span style="font-weight:bold">+</span> id 200

<span style="color:#998;font-style:italic">// Definition
</span><span style="color:#998;font-style:italic"></span><span style="color:#555">Literate</span>.Define id idImpl <span style="font-weight:bold">(</span><span style="font-weight:bold">fun</span> x <span style="font-weight:bold">-&gt;</span> x<span style="font-weight:bold">)</span>
</code></pre></div><h2 id="the-traditional-way">The traditional way</h2>
<p>The traditional way of doing something like this is by passing the function as a parameter in a manner similar to the below.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#998;font-style:italic">// Declaration and usage intermingled
</span><span style="color:#998;font-style:italic"></span><span style="font-weight:bold">let</span> <span style="color:#008080">calculate</span><span style="font-weight:bold">&#39;</span> <span style="font-weight:bold">(</span>add<span style="font-weight:bold">:</span> int <span style="font-weight:bold">-&gt;</span> int <span style="font-weight:bold">-&gt;</span> int<span style="font-weight:bold">)</span> x y <span style="font-weight:bold">=</span> add x y <span style="font-weight:bold">*</span> add x y

<span style="color:#998;font-style:italic">// Definition
</span><span style="color:#998;font-style:italic"></span><span style="font-weight:bold">let</span> <span style="color:#008080">add</span> x y <span style="font-weight:bold">=</span> x <span style="font-weight:bold">+</span> y

<span style="font-weight:bold">let</span> <span style="color:#008080">calculate</span> <span style="font-weight:bold">=</span> calculate&#39; add
</code></pre></div><p>To my way of seeing, this is the most cumbersome solution and conceptually dishonest because you are not parametrizing your function for technical
reasons, but just for the sake of explaining things. In a way, you are changing the signature of your functions for the sake of writing a book.
That can&rsquo;t be right &hellip;</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="font-weight:bold">[&lt;</span>EntryPoint<span style="font-weight:bold">&gt;]</span>
<span style="font-weight:bold">let</span> <span style="color:#008080">main</span> args <span style="font-weight:bold">=</span> myMain args
</code></pre></div>


  
  <div id="disqus-container">
  
    <button id="disqus-button" onclick="showComments()">Show comments</button>
    <div id="disqus-comments">
      
      
      
        <div id="disqus_thread">
        </div>
        <script type="application/javascript">
          function showComments() {
            var disqus_config = function () {
};
// Build and append comments 
var d = document;
var s = d.createElement('script');
s.async = true;
s.src = '//' + "lucabol" + '.disqus.com/embed.js';
s.setAttribute('data-timestamp', + new Date());
(d.head || d.body).appendChild(s);
            // Remove button
var disqusButton = document.getElementById('disqus-button');
disqusButton.parentNode.removeChild(disqusButton); 
// Un-hide comments
var disqusComments = document.getElementById('disqus-comments');
disqusComments.style.display = 'block'; 
          }
        </script>
      
      <noscript>Enable JavaScript to view Disqus comments.</noscript>
    </div>
  
</div>




    </main>

    <aside id="sidebar-left">
        
<div id="tags">
  <header>
    <h1>Tags</h1>
      
    <h2>¬∂</h2>
    
  </header>
  
    
    <nav>
      <ul>
        
            <li><a href="../../MyBlog/tags/c">C</a></li>
        
            <li><a href="../../MyBlog/tags/fsharp">fsharp</a></li>
        
            <li><a href="../../MyBlog/tags/literate-programming">Literate programming</a></li>
        
      </ul>
    </nav>
    
  
</div>

    </aside>

    <aside id="sidebar-right">
        <section id="TOC">
        
  
    <header>
        <h1>Table of contents</h1>
        <h2>¬∂</h2>
    </header>
    <nav id="TableOfContents">
    <ul>
        

        
        <li>
        <a href="#main-ideas">Main ideas</a>
        

        
        <ul>
                <li>
            <a href="#unhappiness-with-existing-tools">Unhappiness with existing tools</a>
        

        
        </li><li>
            <a href="#a-different-interpretation">A different interpretation</a>
        

        
        </li><li>
            <a href="#multi-language-multi-document-format">Multi-language, multi-document format</a>
        

        
        </li><li>
            <a href="#usage">Usage</a>
        

        
        </li><li>
            <a href="#programming-languages-limitations">Programming Languages limitations</a>
        

        
        </li></ul></li><li>
            <a href="#implementation">Implementation</a>
        

        
        <ul>
                <li>
            <a href="#going-over-the-parse-tree">Going over the parse tree</a>
        

        
        </li><li>
            <a href="#narrative-comments-phases">Narrative comments phases</a>
        

        
        </li><li>
            <a href="#parsing-command-line-arguments">Parsing command line arguments</a>
        

        
        </li><li>
            <a href="#main-method">Main method</a>
        

        
        </li></ul></li><li>
            <a href="#an-aside-forward-declaring-functions-in-f">An aside: forward declaring functions in F#</a>
        

        
        <ul>
                <li>
            <a href="#a-simple-solution">A simple solution</a>
        

        
        </li><li>
            <a href="#a-correct-solution-but-ugly">A correct solution (but ugly)</a>
        

        
        </li><li>
            <a href="#the-traditional-way">The traditional way</a>
    </li></ul></li></ul>
</nav>


        </section>
    </aside>

    <a id="to_top" href="#top">Top</a>
    <footer>
        
    </footer>

    <script>
    const th = document.querySelector("#theme")
    th.addEventListener("click", e => {
        const x = document.querySelector(".dropdown-content")
        if (x.style.display === "block") {
            x.removeAttribute("style")
        } else {
            x.style.display = "block";
        }
    })
    const children = document.querySelectorAll(".font-name")
    const allStyles = Array.from(children).map(c => c.dataset.classname)

    const defaultStyle = "TimesNewRoman"
    const retrievedStyle = localStorage.getItem("Style")
    const style = allStyles.includes(retrievedStyle) ? retrievedStyle : defaultStyle
    document.body.className = style;

    const fontEl = document.querySelector(".dropdown-content")
    fontEl.addEventListener("click", e => {
        const el = e.target
        const style = el.dataset.classname
        document.body.className = style;
        localStorage.setItem("Style", style)
    })



</script>
    <script>
const init = () => {

    
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    
    window.ga = window.ga || ((...args) => (ga.q = ga.q || []).push(args));

    ga('create', 'UA-133194891-1', 'auto');
    ga('set', 'transport', 'beacon');
    ga('send', 'pageview');
};


window.addEventListener('load', init);
</script>
    <script>
    if("serviceWorker" in navigator){
        navigator.serviceWorker.register("/sw.js");
    }
</script>
    <script>
    window.addEventListener('offline', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.add("show")
        window.caches.keys().then(strikeNonCached)
    })
    window.addEventListener('online', (e) => {
        const els = document.getElementsByClassName('offline')
        for(const el of els)
            el.classList.remove("show")

        const as = document.querySelectorAll('main a')
        for(const a of as)
            a.classList.remove('strike')
    })

    const strikeNonCached = cacheKeys => {
        caches.open(cacheKeys[0]).then(cache =>
            cache.keys().then(keys => {
                const as = document.querySelectorAll('main a')
                const urls = keys.map(k => k.url)
                for(const a of as)
                    if(urls.indexOf(a.href) === -1)    
                        a.classList.add('strike')
    }))}

    if(navigator.onLine)
        window.dispatchEvent(new Event('online'))
    else
        window.dispatchEvent(new Event('offline'))

</script>
    <script>
function variableResize() {

  
  let bodyStyles = window.getComputedStyle(document.body);	
	
  let root = document.documentElement;
	
	
	const maxWindowSize = bodyStyles.getPropertyValue('--bp-xlarge') * 16;
	const minWindowSize = bodyStyles.getPropertyValue('--bp-small') * 16;
	
	
	const windowWidth = window.innerWidth
	
  
  const pWidthVar = '--p-wdth';
	const pMinFontWidth = bodyStyles.getPropertyValue('--p-wdth-min');
	const pMaxFontWidth = bodyStyles.getPropertyValue('--p-wdth-max');
	scale(pWidthVar, pMinFontWidth, pMaxFontWidth);

  const pWeightVar = '--p-wght';
	const pMinFontWeight = bodyStyles.getPropertyValue('--p-wght-min');
	const pMaxFontWeight = bodyStyles.getPropertyValue('--p-wght-max');
	scale(pWeightVar, pMinFontWeight, pMaxFontWeight);
	
  const h1WidthVar = '--h1-wdth';
	const h1MinFontWidth = bodyStyles.getPropertyValue('--h1-wdth-min');
	const h1MaxFontWidth = bodyStyles.getPropertyValue('--h1-wdth-max');
	scale(h1WidthVar, h1MinFontWidth, h1MaxFontWidth);

  const h1WeightVar = '--h1-wght';
	const h1MinFontWeight = bodyStyles.getPropertyValue('--h1-wght-min');
	const h1MaxFontWeight = bodyStyles.getPropertyValue('--h1-wght-max');
	scale(h1WeightVar, h1MinFontWeight, h1MaxFontWeight);
	
  const h2WidthVar = '--h2-wdth';
	const h2MinFontWidth = bodyStyles.getPropertyValue('--h2-wdth-min');
	const h2MaxFontWidth = bodyStyles.getPropertyValue('--h2-wdth-max');
	scale(h2WidthVar, h2MinFontWidth, h2MaxFontWidth);

  const h2WeightVar = '--h2-wght';
	const h2MinFontWeight = bodyStyles.getPropertyValue('--h2-wght-min');
	const h2MaxFontWeight = bodyStyles.getPropertyValue('--h2-wght-max');
	scale(h2WeightVar, h2MinFontWeight, h2MaxFontWeight);
	
	function scale(varName, minValue, maxValue) {
		
		minValue = minValue * 1;
		maxValue = maxValue * 1;

		
		const percent = (windowWidth - minWindowSize) / (maxWindowSize - minWindowSize);
		if (maxValue < minValue) {
			var valueScale = minValue - (percent * (minValue - maxValue));
		} else {
			var valueScale = (percent * (maxValue - minValue)) + minValue;
		}
	  
		
		const newValue = windowWidth > maxWindowSize
		   ? maxValue 
		   : windowWidth < minWindowSize 
				? minValue 
				: valueScale;
	   
		
		root.style.setProperty(varName, newValue);
	}
}

window.addEventListener("load", variableResize);
window.addEventListener("resize", variableResize);

</script>
    <script>
  const el = document.querySelector("#to_nav")
  el.addEventListener("click", e => {
    const x = document.querySelector("#primary_nav")
    if (x.style.display === "block") {
      x.removeAttribute("style")
    } else {
      x.style.display = "block";
    }
  })
  window.addEventListener('click', e => {
    const x = document.querySelector("#primary_nav")
    const y = document.querySelector("#to_nav")
    if (!y.contains(e.target) && x.style.display === "block") {
      x.removeAttribute("style")
    } 

    const th = document.querySelector("#theme")
    const x1 = document.querySelector(".dropdown-content")

    if (!th.contains(e.target) && ! x1.contains(e.target) && x1.style.display === "block") {
      x1.removeAttribute("style")
    } 
  })
</script>

</body>
</html>